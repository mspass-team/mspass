<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploy MsPASS on HPC &mdash; MsPASS 0.0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MsPASS Setup In-Depth Overview" href="getting_started_overview.html" />
    <link rel="prev" title="Deploy MsPASS with Docker Compose" href="deploy_mspass_with_docker_compose.html" />  

  <style>
    .wy-nav-content { max-width: 1600px; }
  </style>

  
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MsPASS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="run_mspass_with_docker.html">Run MsPASS with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_mspass_with_docker_compose.html">Deploy MsPASS with Docker Compose</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deploy MsPASS on HPC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-singularity">Introduction to Singularity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-mspass-container">Create MsPASS Container</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-for-single-node-script">Configuration for Single Node script</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-for-distributed-node-script">Configuration for Distributed Node Script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_overview.html">MsPASS Setup In-Depth Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/data_object_design_concepts.html">Data Object Design Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/time_standard_constraints.html">Time Standard Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/obspy_interface.html">Using ObsPy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/database_concepts.html">Database Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/CRUD_operations.html">CRUD Operations in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/importing_data.html">Importing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/handling_errors.html">Handling Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/data_editing.html">Data Editing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/header_math.html">Header (Metadata) Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/graphics.html">Graphics in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/processing_history_concepts.html">Processing History Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/parallel_processing.html">Parallel Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/normalization.html">Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/adapting_algorithms.html">Adapting an Existing Algorithm to MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cxx_api/index.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mspass_schema/mspass_schema.html">MsPASS Schema</a></li>
</ul>

    <a href= "../genindex.html">Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MsPASS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Deploy MsPASS on HPC</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mspass-team/mspass/blob/master/docs/source/getting_started/deploy_mspass_on_HPC.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deploy-mspass-on-hpc">
<span id="id1"></span><h1>Deploy MsPASS on HPC<a class="headerlink" href="#deploy-mspass-on-hpc" title="Permalink to this heading"></a></h1>
<section id="introduction-to-singularity">
<h2>Introduction to Singularity<a class="headerlink" href="#introduction-to-singularity" title="Permalink to this heading"></a></h2>
<p>Singularity is a container implementation that runs on HPC cluster environments. Singularity provides similar features as Docker, and can handle the “escalated privilege” issue of Docker. Singularity is compatible with Docker containers, which means that one can develop the container in Docker, and use Singularity as the runtime on HPC clusters.</p>
</section>
<section id="create-mspass-container">
<h2>Create MsPASS Container<a class="headerlink" href="#create-mspass-container" title="Permalink to this heading"></a></h2>
<p>Singularity is compatible with docker container, which is a more widely-used implementation.
So we can build a singularity image from the MsPASS container hosted on Docker Hub.
First of all, use the following command to load the singularity module.
Here we use TACC’s Stampede2 system as an example, where you need to first get on to a compute node to be able to use Singularity.
For other systems, you should be able to find specific instructions on running containers there.
For example, <a class="reference external" href="https://containers-at-tacc.readthedocs.io/en/latest/index.html">this</a> is the container tutorial at TACC.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">tacc</span><span class="o">-</span><span class="n">singularity</span>
</pre></div>
</div>
<p>Then, execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singularity</span> <span class="n">build</span> <span class="n">mspass_latest</span><span class="o">.</span><span class="n">sif</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">mspass</span><span class="o">/</span><span class="n">mspass</span>
</pre></div>
</div>
<p>The command above will build a Singularity container corresponding to the latest released MsPASS docker container and save as <code class="code docutils literal notranslate"><span class="pre">mspass_latest.sif`</span></code> in the current directory.</p>
<p>Now we can run MsPASS using Singularity. However, lots of configurations are needed, especially when
user wants to run MsPASS on distributed nodes, where each node perform a different role. To simplify the configuration,
two example scripts are given: <a class="reference external" href="https://github.com/mspass-team/mspass/blob/master/scripts/tacc_examples/single_node.sh">single_node.sh</a>
and <a class="reference external" href="https://github.com/mspass-team/mspass/blob/master/scripts/tacc_examples/distributed_node.sh">distributed_node.sh</a>.</p>
<p>In this section, we will briefly describe how to use these scripts.</p>
<p>Please note that these scripts are written for the TACC environment, users might need to make some changes to the scripts to accustom them with their own HPC environment.</p>
</section>
<section id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this heading"></a></h2>
<p>To run the MsPass on Stampede2, simply use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbatch</span> <span class="o">./</span><span class="n">single_node</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbatch</span> <span class="o">./</span><span class="n">distributed_node</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>The sbatch commands will submit the batch file to the cluster. Then, the workload manager (Slurm) will allocate the nodes and run the batch script on the first node allocated.</p>
<p>After the script is commited and executed, a file will be created on the current directory (mspass.o{JOBID}), it stores all the log from MsPass:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Sun Mar 20 02:44:20 CDT 2022
primary node c492-092
got login node port 19292
Created reverse ports on Stampede2 logins
cleaning done
[WARN  tini (144729)] [WARN  tini (144730)] Tini is not running as PID 1 and isn&#39;t registered as a child subreaper.
Zombie processes will not be re-parented to Tini, so zombie reaping won&#39;t work.
Zombie processes will not be re-parented to Tini, so zombie reaping won&#39;t work.

[WARN  tini (206416)] Tini is not running as PID 1 and isn&#39;t registered as a child subreaper.
Zombie processes will not be re-parented to Tini, so zombie reaping won&#39;t work.
[WARN  tini (145112)] Tini is not running as PID 1 and isn&#39;t registered as a child subreaper.
Zombie processes will not be re-parented to Tini, so zombie reaping won&#39;t work.
To fix the problem, use the -s option or set the environment variable TINI_SUBREAPER to register Tini as a child subreaper, or run Tini as PID 1.
[I 02:46:48.738 NotebookApp] Serving notebooks from local directory: /scratch/08431/ztyang/mspass/workdir
[I 02:46:48.738 NotebookApp] Jupyter Notebook 6.2.0 is running at:
[I 02:46:48.738 NotebookApp] http://c492-092.stampede2.tacc.utexas.edu:8888/?token=fee57b8bf77dc608fc32ecf6ad8d85a70467d84cf52b439d
[I 02:46:48.738 NotebookApp]  or http://127.0.0.1:8888/?token=fee57b8bf77dc608fc32ecf6ad8d85a70467d84cf52b439d
[I 02:46:48.738 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
[C 02:46:48.749 NotebookApp]

    To access the notebook, open this file in a browser:
        file:///home1/08431/ztyang/.local/share/jupyter/runtime/nbserver-145143-open.html
    Or copy and paste one of these URLs:
        http://c492-092.stampede2.tacc.utexas.edu:8888/?token=fee57b8bf77dc608fc32ecf6ad8d85a70467d84cf52b439d
    or http://127.0.0.1:8888/?token=fee57b8bf77dc608fc32ecf6ad8d85a70467d84cf52b439d
</pre></div>
</div>
<p>As can be seen from above, you will get the token for jupyter notebook from the log. If the reverse tunnel port is enabled, you will get a login node port. Replace the 8888 with the new port number, you will get the external jupyter link. (In this case, <code class="docutils literal notranslate"><span class="pre">http://stampede2.tacc.utexas.edu:19292/?token=fee57b8bf77dc608fc32ecf6ad8d85a70467d84cf52b439d</span></code>). In the meanwhile, another port will also be open for the status page, the port number is new port number + 1.</p>
<p>When MsPass is running, check the task status using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">showq</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">mspass</span>
</pre></div>
</div>
<p>To stop the MsPass task, you can simply wait till the end of the run time, or explicitly cancel the task using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scancel</span> <span class="p">{</span><span class="n">JOBID</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="configuration-for-single-node-script">
<h2>Configuration for Single Node script<a class="headerlink" href="#configuration-for-single-node-script" title="Permalink to this heading"></a></h2>
<p>single_node.sh is for setting up a standalone instance with the mongodb server, dask scheduler and worker, and the jupyter frontend all on a single node.</p>
<p>The script first setup some environment variables for HPCs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH -J mspass           # Job name</span>
<span class="c1">#SBATCH -o mspass.o%j       # Name of stdout output file</span>
<span class="c1">#SBATCH -p skx-dev          # Queue (partition) name</span>
<span class="c1">#SBATCH -N 1                # Total # of nodes (must be 1 for serial)</span>
<span class="c1">#SBATCH -n 1                # Total # of mpi tasks (should be 1 for serial)</span>
<span class="c1">#SBATCH -t 02:00:00         # Run time (hh:mm:ss)</span>
<span class="c1">#SBATCH -A MsPASS           # Allocation name (req&#39;d if you have more than 1)</span>
</pre></div>
</div>
<p>You might want to change some of these fields. Note: the queue name and allocation name here refer to
<a class="reference external" href="https://portal.tacc.utexas.edu/user-guides/stampede2#running-queues">TACC Slurm Queues</a> and <a class="reference external" href="https://portal.tacc.utexas.edu/allocations-overview">TACC Allocation</a>.</p>
<p>In HPC environment, users could only get access to the services on limited nodes (login1 - login4 in Stampede2). So we need to create reverse tunnel port to support external access to the jupyter notebook and the <a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-distributed.html">status page</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in `seq 4`; do
    ssh -q -f -g -N -R $LOGIN_PORT:$NODE_HOSTNAME:8888 login$i
    ssh -q -f -g -N -R $STATUS_PORT:$NODE_HOSTNAME:8787 login$i
done
</pre></div>
</div>
<p>The code above creates one tunnel for each login node so that the users can just connect to stampede.tacc to visit the jupyter notebook and the status page. If you are not using a TACC machine, you might need to modify or delete this part to run on your own HPC environment.</p>
<p>Some other variables you might need to change:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">WORK_DIR</span></code>: This is a directory path to store all runtime dat.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MSPASS_CONTAINER</span></code>: This is the path to the singualrity image to run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DB_PATH</span></code>: This variable indicates where the db data are stored,
there are two options: ‘scratch’ and ‘tmp’. ‘scratch’ saves the DB data to a shared filesystem, ‘tmp’ saves the DB data to a local filesystem.
For more details on the difference between tmp and scratch, please refer to <a class="reference external" href="https://portal.tacc.utexas.edu/user-guides/stampede2#overview-filesystems">TACC user guide</a>.</p></li>
</ul>
</section>
<section id="configuration-for-distributed-node-script">
<h2>Configuration for Distributed Node Script<a class="headerlink" href="#configuration-for-distributed-node-script" title="Permalink to this heading"></a></h2>
<p>To run MsPass on a distributed cluster, use the distributed_node script.</p>
<p>similar the single node script, the distribute node script also does setup at the beggining:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH -J mspass           # Job name</span>
<span class="c1">#SBATCH -o mspass.o%j       # Name of stdout output file</span>
<span class="c1">#SBATCH -p skx-dev          # Queue (partition) name</span>
<span class="c1">#SBATCH -N 3                # Total # of nodes (must be 1 for serial)</span>
<span class="c1">#SBATCH -n 3                # Total # of mpi tasks (should be 1 for serial)</span>
<span class="c1">#SBATCH -t 02:00:00         # Run time (hh:mm:ss)</span>
<span class="c1">#SBATCH -A MsPASS           # Allocation name (req&#39;d if you have more than 1)</span>
</pre></div>
</div>
<p>The main difference here is the number of nodes and mpi tasks should be set to more than 1. One can set these two value to any number, but a larger number might result in longer waiting time in queue.</p>
<p>For the distribute node script, here are some variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HOSTNAME_BASE</span></code>: This is the base address for each node, for example, on stampede environment, it should be ‘stampede2.tacc.utexas.edu’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DB_SHARDING</span></code>: This is a boolean value indicating whether the sharding is in use or not.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHARD_DATABASE</span></code>: This is the name of the database that users want to enable sharding.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHARD_COLLECTIONS</span></code>: This is the collection and index that users want to use for sharding, for example: <code class="docutils literal notranslate"><span class="pre">(&quot;arrival:_id&quot;)</span></code></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="deploy_mspass_with_docker_compose.html" class="btn btn-neutral float-left" title="Deploy MsPASS with Docker Compose" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="getting_started_overview.html" class="btn btn-neutral float-right" title="MsPASS Setup In-Depth Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, Ian Wang.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>