<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using MongoDB with MsPASS &mdash; MsPASS 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=f6245a2f"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Normalization" href="normalization.html" />
    <link rel="prev" title="CRUD Operations in MsPASS" href="CRUD_operations.html" />  

  <style>
    .wy-nav-content { max-width: 1600px; }
  </style>

  
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MsPASS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/run_mspass_with_docker.html">Run MsPASS with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/deploy_mspass_with_docker_compose.html">Deploy MsPASS with Docker Compose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/deploy_mspass_on_HPC.html">Deploying MsPASS on an HPC cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started_overview.html">MsPASS Virtual Cluster Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Management</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="database_concepts.html">Database Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="CRUD_operations.html">CRUD Operations in MsPASS</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using MongoDB with MsPASS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prof-gary-l-pavlis"><em>Prof. Gary L. Pavlis</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="#overview-and-roadmap">Overview and Roadmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="#concepts">Concepts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mongodb-for-rdbms-users">MongoDB for RDBMS Users</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mongodb-for-python-programmers">MongoDB for Python programmers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mongodb-for-pandas-users">MongoDB for Pandas Users</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#queries-read-of-crud">Queries (Read of CRUD)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#query-language">Query language</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-methods">Query methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-single-key-queries">Simple (single key) queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-key-queries">Multiple key queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compound-queries">Compound queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#geospatial-queries">Geospatial queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sorting">Sorting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#report-generators">Report generators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#saves-create-of-crud">Saves (Create of CRUD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updates-u-of-crud">Updates (U of CRUD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#delete-d-of-crud">Delete (D of CRUD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#indexes">Indexes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="normalization.html">Normalization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Seismic Data Objects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_object_design_concepts.html">Data Object Design Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="numpy_scipy_interface.html">Using numpy/scipy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="obspy_interface.html">Using ObsPy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="time_standard_constraints.html">Time Standard Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_history_concepts.html">Processing History Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="continuous_data.html">Continuous Data Handling with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema_choices.html">What database schema should I use?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="importing_data.html">Importing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="handling_errors.html">Handling Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_editing.html">Data Editing</a></li>
<li class="toctree-l1"><a class="reference internal" href="header_math.html">Header (Metadata) Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="graphics.html">Graphics in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal_to_noise.html">Signal to Noise Ratio Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="adapting_algorithms.html">Adapting an Existing Algorithm to MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">System Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parallel_processing.html">Parallel Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory_management.html">Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="io.html">I/O in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel_io.html">Parallel IO in MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequency Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_strategies.html">How do I develop a new workflow from scratch?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cxx_api/index.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mspass_schema/mspass_schema.html">MsPASS Schema</a></li>
</ul>

    <a href= "../genindex.html">Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MsPASS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Using MongoDB with MsPASS</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mspass-team/mspass/blob/master/docs/source/user_manual/mongodb_and_mspass.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="using-mongodb-with-mspass">
<h1>Using MongoDB with MsPASS<a class="headerlink" href="#using-mongodb-with-mspass" title="Permalink to this heading"></a></h1>
<section id="prof-gary-l-pavlis">
<h2><em>Prof. Gary L. Pavlis</em><a class="headerlink" href="#prof-gary-l-pavlis" title="Permalink to this heading"></a></h2>
</section>
<section id="overview-and-roadmap">
<h2>Overview and Roadmap<a class="headerlink" href="#overview-and-roadmap" title="Permalink to this heading"></a></h2>
<p>There are a huge number of internet and printed resources on the
Database Management system used in MsPASS called <cite>MongoDB</cite>.
The reason is that MongoDB is one of the most heavily used open source
packages in the modern software ecosystem.  For that reason in earlier
verisions of our User’s Manual we simply punted the ball and told User’s
to consult online sources.  It became clear, however, that the
firehose of information that approach creates is not for everyone.
Hence, we created this section to reduce the firehose to a, hopefully,
manageable stream of information.</p>
<p>The first section, which is titled “Concepts”, is introductory material.
The material, however, is broken into subsections directed a people
with specific backgrounds.   If the title matches you start there.  If
you fit none of the descriptions, read them all.  The sections after that
are organized by the letters of the standard acronymn used in
many sources on database system:  CRUD (Create, Read, Update, and Delete).
The final section covers an auxiliary issue of MongoDB indexes.
indexes are critical for read performnce, but are not required.</p>
</section>
<section id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this heading"></a></h2>
<section id="mongodb-for-rdbms-users">
<h3>MongoDB for RDBMS Users<a class="headerlink" href="#mongodb-for-rdbms-users" title="Permalink to this heading"></a></h3>
<p>Users who are familiar with Relational DataBase Management Systems (RDBMS)
will find MongoDB has many similar concepts, but also is fundamentally
different from any RDBMS.  In and RDBMS the conceptual model of the data
structure the system manages is a table (A “relation” in database theory
is synonymous with “table”.) That is, however, better thought of as an
implementation detail for what the system is aiming to do.
Computer science textbooks on database theory make heavy use of set theory
at think of a database as an abstract set of “attribute” that define
some property and have some relationship.   Some kinds of data fit the
tabular model well, but some do not fit the concept at all.
Seismic data objects are a case in point;  traditional “header” attributes
like those in SAC or SEGY map well into the RDBMS model well things like
the sample data and response information are awkward, at best, to handle
that way.   If you are a user of a system like Antelope that uses CSS3.0
you will know what I mean.  The other fundamental weakness of the
tabular model is handling the “null” problem.   That is, if an attribute
is optional the table has too define what defines a null value.
MongoDB suffers neither of those issues, but has its own “implementation
details” that we will discuss later.</p>
<p>A relation (table) indexes a given piece of data by row and column.
aka key that defines the column index.  The rows (tuples) have
an implicit index defined by the “primary keys” of the relation.
(They sometimes have alternate keys, but that is a detail.)
The primary key always has some indexing scheme to speed lookup
by that key.   One way to think of MongoDB’s data model is to
think of it a collection of binary blobs (a list) with one or more
fast indexing methods that allow random retrieval of any of the
things it stores by the index.   It is like a relation with only
tuples and the tuples have no restrictions other than
a requirement that they contain the
indexing attribute.  These open-ended tuples are called “documents”.
The contents of the documents are not, however, just a binary blob.
The contents are REQUIRED to be indexable as key-value pairs
(The same concept as a python dictionary discussed in the next section.).
The “value” associated with the key has no restriction, but
the approach makes no sense unless the “value” can be translated into
something that matches the concept that key is supposed to reference.
For example, a seismic station “name” is a unique tag seismologists
use describe a particular observatory/site.   Earthquake seismologists
nearly always use human-generated names stored as a string.
Multichannel seismic data managment systems (e.g. Seismic Unix)
commonly use an integer index to define a given position because
survey flags are commonly defined by sequential numbers defining positions
along a line/profile.   Conceptually, however, both approaches require the
same thing.  An index (station name or station index number) is used
to define a particular geographic location.  Different keywords (keys)
are used to define particular concepts.   For the case in point,
in MsPASS we use
“lat”, “lon”, and “elev” as keys to define an instruments geographic
position. Fetching all three from a particular document will produce all
the data required to define a unique position.  The same thing is done
in an RDBMS, but the table model is used to define the model of how
to fetch a particular attribute by a similar key.   e.g. in the CSS3.0
schema the same three  attributes have the same keys.
That is, the CSS3.0 standard defines the keys “lat”, “lon”, and “elev”
as latitude, longitude, and elevation.</p>
<p>In MongoDB the equivalent of a table (relation) is called a “collection”.
A more technical definition of a “collection” is a set of “documents”
accessible with a random access iterator.   What that means, in practice,
is that a collection act like an RDBMS table in the sense that the
contents can be sorted into any order or subsetted with a query.
There is not such thing, however, as “SELECT”.   Documents have to
always be eaten whole and chewed on a bit if you need to access only
a limited set of attributes in each document.  The thing that makes
a relational database “relational” is not done well by MongoDB.
That is, various forms of a “join” between two tables are a fundamental
operation in most, if not all operational relational database systems.
MongoDB has the equivalent in what it calls “normalization”, but
our experience is it is much slower than comparable operations with
an RDBMS.   We discuss normalization at length in the
related section of the User’s Manual titled <a class="reference internal" href="normalization.html#normalization"><span class="std std-ref">Normalization</span></a>.
The results of a query
can also be “grouped”, but require very different programming constructs than
SQL.</p>
<p>Perhap the most important common construct used by all RDBMS systems I
know of and MongoDB is the concept of a “cursor”.   In an RDBMS a cursor
is a forward-iterator (i.e. it can only be incremented) that loops over the set of tuples returned by a query.
In MongoDB is is more-or-less the same thing with different words.
A MongoDB cursor is a forward-iterator that can be used to work through
a set of documents returned by a query.  We will see numerous examples
of using cursors in the MsPASS User’s manual and any source discussing
MongoDB.</p>
</section>
<section id="mongodb-for-python-programmers">
<h3>MongoDB for Python programmers<a class="headerlink" href="#mongodb-for-python-programmers" title="Permalink to this heading"></a></h3>
<p>All python programmers will be familiar with the container
commonly called a “dictionary” (dict).   Other sources call the same concept
an “associative array” (Antelope) or “map container” (C++ and Java).
Why that is important for MongoDB is simple:  the python binds for
MongoDB (<cite>pymongo</cite>) used a dict to structure the content of what
MongoDB calls a “document” AND pymongo uses dict containers as the base of
its query language.   Two simple examples from the related tutorial notebook
illustrate this.</p>
<p><em>Document output example:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">json_util</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_minised</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json_util</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>Produces:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Paste</span> <span class="n">here</span>
</pre></div>
</div>
<p><em>Query example:</em></p>
<div class="highlight-language notranslate"><div class="highlight"><pre><span></span>query=dict()
query[&#39;sta&#39; : &#39;AAK&#39;]
query[&#39;chan&#39;] : &#39;BHZ&#39;
query[&#39;loc&#39;] = &#39;00&#39;
print(&quot;query content in pretty form&quot;)
print(json_util.dumps(doc,indent=2))
doc=db.wf_miniseed.find_one(query)
print(&quot;output of query&quot;)
print(json_util.dumps(doc,indent=2))
</pre></div>
</div>
</section>
<section id="mongodb-for-pandas-users">
<h3>MongoDB for Pandas Users<a class="headerlink" href="#mongodb-for-pandas-users" title="Permalink to this heading"></a></h3>
<p>Most users who have had any significant experience with python will
likely have encountered pandas.   The name “pandas” is
one of those strained acronymns.   Multiple online sources indicate the
name comes from “panel data”, which is basically an stretch of a name for
a table.  That insight is fundamental as pandas can be thought of as
little more a python version of a spreadsheet.   In addition, more
elaborate features of the panda API can be used to mimic much of
an RDBMS functionality.</p>
<p>Since pandas are little more than an API for manipulating tables,
linking pandas to MongoDB differs little from linking an RDBMS table
to MongoDB.  What I mean by that is perhaps best illustrated by
an example.  The <a class="reference external" href="https://brtt.com/software/">Antelope software</a>
used by many seismologists is a “flat-file” RDBMS.  It stores tabular
data in simple text files that can be viewed with standard unix tools.
(Note most RDBMS systems hide data behind the API like MongoDB does and
the data are stored in some binary set of files accessible only through
a server.)  Antelope uses the CSS3.0 schema.   One of way pandas can
be used with MsPASS is to import CSS3.0 tables.   With Antelope
files that is easily done with the <cite>read_fsf</cite> function in pandas.  The
following illustrates an alternative way to create a <cite>site</cite> collection
from an Antelope “site” table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">,</span><span class="s1">&#39;ondate&#39;</span><span class="p">,</span><span class="s1">&#39;offdate&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;elev&#39;</span><span class="p">,</span><span class="s1">&#39;statype&#39;</span><span class="p">,</span><span class="s1">&#39;refsta&#39;</span><span class="p">,</span><span class="s1">&#39;dnorth&#39;</span><span class="p">,</span><span class="s1">&#39;deast&#39;</span><span class="p">,</span><span class="s1">&#39;lddate&#39;</span><span class="p">]</span>
<span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">17</span><span class="p">]</span>  <span class="c1"># need the antelope schema file to get these</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="s1">&#39;demo.site&#39;</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span><span class="n">widths</span><span class="o">=</span><span class="n">widths</span><span class="p">)</span>
<span class="n">doclist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
<span class="c1"># This loop is needed to convert ondate and offdate to starttime and</span>
<span class="c1"># endtime used in MsPASS.</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doclist</span><span class="p">:</span>
  <span class="c1"># In CSS3.0 these are integers for year day.  UTCDateTime</span>
  <span class="c1"># converts correctly ONLY if it is first converted to a string</span>
  <span class="n">ondate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;ondate&#39;</span><span class="p">])</span>
  <span class="n">offdate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;offdate&#39;</span><span class="p">])</span>
  <span class="n">starttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">ondate</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
  <span class="n">enddate</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">offdate</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
  <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">starttime</span>
  <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">endtime</span>
<span class="c1"># this script assumes db is a MongoDB Database handle set earlier</span>
<span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">doclist</span><span class="p">)</span>
</pre></div>
</div>
<p>A few details worth noting about this example:</p>
<ul class="simple">
<li><p>The list of keywords assigned to the symbol <cite>keys</cite> is needed because
Antelope wfdisc fles do not have attribute names as the first line of
the file.   The list used above uses CSS3.0 attribute names.  The order
is significant as the names are tags on each column of data loaded
with <cite>read_fsf</cite>.</p></li>
<li><p>The <cite>widths</cite> symbol is set to a list of fixed field widths.  They ere
derived from the antelope schema file.</p></li>
<li><p>The call to the pandas <cite>to_dict</cite> method converts the pandas table to
a list of python dictionaries.</p></li>
<li><p>The for loop after the call to <cite>to_dict</cite> is not strictly necessary.
It is used in this example to produce a “site collection” consistent
with the MsPASS namespace.   This is an example of a disconnect in
concept between two database systems.  CSS3.0 is an older standard and
the committee that developed it elected to store the “ondate” and “offdate”
fields as integers that specified time to the nearest day.  The SEED
standard changed the equivalent to a time stamp normally specified as
a unix epoch time or a date string.  Here we convert the time to a
unix epoch time through obspy’s UTCDateTime class.</p></li>
<li><p>The last line is the only MongoDB component of this script.  More examples
like this are seen below.  A key point here is that <cite>insert_many</cite> can
handle any number of documents defined in doclist.   It is, of course,
memory limited because pandas and <cite>doclist</cite> are all in memory.  The
del call in the script demonstates good practice to release potentially
large memor objects like <cite>df</cite> after they are no longer needed.</p></li>
</ul>
<p>The above example works for the special case of Antelope text-based
database files.   The pandas API, as experienced pandas users know,
has a rich set of readers that can read nearly any imaginable
tabular data format from files, sql servers, and online sources.  These are documented
<a class="reference external" href="https://pandas.pydata.org/docs/reference/io.html">here</a> and include
Excel, csv, and json formatted files, SQL servers, and jargon most of
us have never seen.  I have found that for research problems the fact that MongoDB
documents are completely agnostic about content can be very helpful.
For a new problem it is trivial to create a new collection and start putting
things (documents) into it and have the data available by MongoDB queries.
Readers should realize the schema we imposed on seismic waveform collections
was imposed to provide a standardized namespace for keys to allow the
framework to be extended without breaking lower level functionality.
For the exploration stages of a research problem having now schema
constraints is a very useful feature of MongoDB. Importing data through
pandas is a particularly simple way to import many forms of data
you may acquire from internet sources today.</p>
<p>A final key point about pandas is that both dask and pyspark
have a parallel equivalent.  Both refer to the
equivalent of a pandas data structure as
a <cite>DataFrame</cite>.   A large fraction of the pandas API are available
in the dask and pyspark DataFrame API.  Experienced pandas users
may find it helpful in handling large tabular data sets to develop
applications with MsPASS that use the DataFrame API to manipulate
the tabular data.  With dask or pyspark most pandas operations
can be parallelized.</p>
</section>
</section>
<section id="queries-read-of-crud">
<h2>Queries (Read of CRUD)<a class="headerlink" href="#queries-read-of-crud" title="Permalink to this heading"></a></h2>
<section id="query-language">
<h3>Query language<a class="headerlink" href="#query-language" title="Permalink to this heading"></a></h3>
<p>In my experience the single most important usage of a database like
MongoDB in MsPASS research data processing is defining queries to
select a subset of data holdings or to define groupings (ensembles)
to be processed together.  A barrier to usage, however, is that
MongoDB uses a unique and rather strange query language that users
familiar with a language like SQL will find foreign.   Furthermore,
the biggest weakness I’ve seen in any
online source I’ve found on MongoDB usage is a failure to
address the fundamental syntax of the query language.
All sources seem to think the best way to understand the
language is from examples.  Somewhat true, but many of us find it
easier to remember a few basic rules than a long list of
incantations.   This section is an attempt to provide some
simple rules that can, I hope, help you better understand the
MongoDB query language.  Here are what seem to me to be the
fundamental rules:</p>
<ol class="arabic simple">
<li><p>All queries use a python dictionary to contain the instructions.</p></li>
<li><p>The key of a dictionary used for query normally refers to an attribute
in documents of the collection being queried.  There is an exception
for the logical OR and logical AND operators (discussed below).</p></li>
<li><p>The “value” of each key-value pair is normally itself a python
dictionary.   The contents of the dictionary define a simple
language (Mongo Query Language) that resolves True for a match
and False if there is no match.</p></li>
<li><p>The keys of the dict containers that are on the value side of
a query dict are normally operators.  Operators are defined with
strings that begin with the “$” symbol.</p></li>
<li><p>Simple queries are a single key-value pair with the value either
a constant or a dictionary with a single operator key.  e.g.
to a test for the “sta” attribute being the constant “AAK” the
query could be either <cite>{“sta” : “AAK”}</cite> or <cite>{“sta” : {“$eq” : “AAK”}}</cite>.
The form with constant value only works for “$eq”.</p></li>
<li><p>Compound queries (e.g. time interval expressions) have a value
with multiple operator keys.</p></li>
</ol>
<p>In the examples below, refer back to these rules to help you remember
these fundamentals.</p>
</section>
<section id="query-methods">
<h3>Query methods<a class="headerlink" href="#query-methods" title="Permalink to this heading"></a></h3>
<p>Querying (read) is again a “collection operation”.   That is, if we set
the symbol <cite>db</cite> to a MsPASS or MongoDB <cite>Database</cite> object, the query
functions are “methods” of a collection object.   (see longer discussion
above in the “Create” section)  There are three standard methods for
the “Read” part of CRUD.  We will show examples of all three below.</p>
<ol class="arabic simple">
<li><p><cite>find_one</cite> returns a document that is the first document found matching
a query operator.</p></li>
<li><p><cite>find</cite> returns a MongoDB
<a class="reference external" href="https://www.mongodb.com/docs/v3.0/core/cursors/">Cursor object</a>
that can be used to iterate through query that returns many documents.</p></li>
<li><p><cite>count_documents</cite> is a utility function used to bound how many documents
match a particular query.</p></li>
</ol>
<p>Examples of the use of each of the three functions above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;AAK&#39;</span><span class="p">}</span>  <span class="c1"># shorthand for {&#39;sta&#39; : {&#39;$eq&#39; : &#39;AAK&#39;}}</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First matching document in site collection for query=&quot;</span><span class="p">,</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All documents in site collection for query=&quot;</span><span class="p">,</span><span class="n">query</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">n_matches</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of documents matching query=&quot;</span><span class="p">,</span><span class="n">query</span><span class="p">,</span><span class="s2">&quot; is &quot;</span><span class="p">,</span><span class="n">n_matches</span><span class="p">)</span>
</pre></div>
</div>
<p><cite>find</cite> and <cite>find_one</cite> are the basic document-level fetching methods.
The examples above show the most common, simple usage.
Both, however, actually have three positional arguments with defaults
you should be aware of.</p>
<ol class="arabic simple">
<li><p><cite>arg0</cite> defines the query operator.  The default is an empty dictionary
that is interpreted as “all”.</p></li>
<li><p><cite>arg1</cite> defines a “projection” operator.  That means it is expected to
be a python dictionary defining what attributes are to be retrieved or
excluded from the returned value(s).   For RDBMS users a “projection”
in MongoDB is like the SELECT clause in SQL.  That idea is best
illustrated by examples below.</p></li>
<li><p><cite>arg2</cite> is an “options” operator.   I have personally never found a
use for any of the listed options in the MongoDB documenation.  I can’t
even find an online example so “options” are clearly an example of
“an advanced feature” you can ignore until needed.</p></li>
</ol>
<p>Note also that a <cite>find_one</cite> returns only a single “document”, which
pymongo converts to a python dictionary.   The <cite>find</cite> method, in
contrast returns a pymongo <cite>Cursor</cite> object.  A <cite>Cursor</cite> is, in the
the jargon of data structures, a “forward iterator”.  That means it can
only be traversed in one direction from the first to last document retrieved
by the MongoDB server.  There is a <cite>rewind</cite> method for the cursor object
but it is of use largely for interactive debugging.</p>
<p>We will next consider a series of increasingly complicated examples.</p>
</section>
<section id="simple-single-key-queries">
<h3>Simple (single key) queries<a class="headerlink" href="#simple-single-key-queries" title="Permalink to this heading"></a></h3>
<p>Single key queries are always of the form:
<cite>{key : expression}</cite> where <cite>key</cite> is the attribute that is to be tested
by the query and <cite>expression</cite> is either: (1) another dictionary or
(2) a single value.  An example is the same one we used above.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;AAK&#39;</span><span class="p">}</span>
<span class="n">query2</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$eq&#39;</span> <span class="p">:</span> <span class="s1">&#39;AAK&#39;</span><span class="p">}}</span>
</pre></div>
</div>
<p><cite>query1 and `query1</cite> are completely equivalent.
Both are equality tests for the attribute with
the key “sta” matching a particular, unique name “AAK”.</p>
<p>A similar inequality test for waveforms having <cite>starttime</cite> values
after a particular date is the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>
<span class="n">t_cutoff</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="s1">&#39;2012-07-28T00:00:00.00&#39;</span><span class="p">)</span>
<span class="c1"># query here needs to convert to a unix epoch time (timestamp method)</span>
<span class="c1"># for numerical comparison to work</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="p">:</span> <span class="n">t_cutoff</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()}}</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_miniseed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<p>MQL has a rich collection of operators.
<a class="reference external" href="https://www.mongodb.com/docs/manual/reference/operator/query/">This page</a>
of the MongoDB documentation has the complete list. A particularly useful
one for most seismologists that is typically omitted from introductory
tutorials is the
<a class="reference external" href="https://www.mongodb.com/docs/manual/reference/operator/query/regex/#mongodb-query-op.-regex">$regex</a>
operator.  $regex can be used to apply a unix regular expression in
a query operation.   Most seismologists are familiar with the regular
expression syntax from using the unix shell.   The following, for
example, could be used to select only PASSCAL temporary experiments
from a site collection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;net&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$regex&#39;</span> <span class="p">:</span> <span class="s1">&#39;X.&#39;</span><span class="p">}}</span>
</pre></div>
</div>
<p>Note that works because of an FDSN convention that net codes starting
with “X” are shorter term deployments.   Regular expressions are a rich
language for text-based filtering.  See the link above or do a web
search for more examples.</p>
</section>
<section id="multiple-key-queries">
<h3>Multiple key queries<a class="headerlink" href="#multiple-key-queries" title="Permalink to this heading"></a></h3>
<p>A query to test the value of more than one attribute uses a dictionary
with multiple keys.  In most cases the key
defines an attribute to be each tested for matches by the query operation.
The key can, however, also sometimes be an operator, in which case
the dictionary would be called a “compound query” (see example below).
For a normal example, the following can be used to find all documents for
all channels for station with net code “II” and station code “PFO”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;II&#39;</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PFO&#39;</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
<p>I used an explicit code to set the query dict container for instructional
purposes.  That form emphasizes that <cite>query</cite> is a python dictionary
and the query uses ‘net’ and ‘sta’ attributes.
Most online sources use the inline form for defining a python
dictionary.  That is, the following could be used to replace the query definition
above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;net&#39;</span> <span class="p">:</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;PFO&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>For simple queries the inline form is generally easier.  I  have found,
however, that for complex queries like examples below the form using
key-value setting pairs is less error prone.  Complex inline expressions
can easily get confused with which curly backet belongs where.</p>
<p>A final important point about multiple attribute queries is that
there is and implied “AND” opertions between the dictionary components.
For example, the example query above could be stated in workds as:
<cite>net attribute is ‘II’ AND sta attribute is ‘PFO’</cite>.  A logical “OR”
query equivalent requires a compound query (next section).</p>
</section>
<section id="compound-queries">
<h3>Compound queries<a class="headerlink" href="#compound-queries" title="Permalink to this heading"></a></h3>
<p>Compound queries mean multiple conditions applied to one or more attributes.
A type example is a very common one in seismology.  That is, waveform
data are always stored as segments with each segment having a start time
(<cite>starttime</cite> in the stock MsPASS namespace) and ending time
(<cite>endtime</cite> in the MsPASS namespace).   We often want to extract
a waveform segment with a particular time span from a database indexing
an entire dataset.   That dataset may be larger windows downloaded
previously or an archive of continuous data commonly stored as day files.
The problem is complicated by the fact that a requested time window
may span the artificial gap at day boundaries in continuous data or
data gaps that are marked in the set of wf documents as a break
with a particular time window.</p>
<p>With that long introduction, here is an example for a single channel
request.  In particular, this example reads a month of “LHZ”
channel data for station “PFO” and loads the results into a
<cite>TimeSeriesEnsemble</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>
<span class="c1"># Example to select the month of June of 2012</span>
<span class="n">tsutc</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="s1">&#39;2012-06-01T00:00:00.0&#39;</span><span class="p">)</span>
<span class="n">teutc</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="s1">&#39;2012-07-01T00:00:00.0&#39;</span><span class="p">)</span>
<span class="n">ts</span><span class="o">=</span><span class="n">tsutc</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
<span class="n">te</span><span class="o">=</span><span class="n">teutc</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;II&#39;</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PFO&#39;</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;chan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LHZ&#39;</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;$and&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
   <span class="p">{</span><span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lte&#39;</span> <span class="p">:</span> <span class="n">te</span><span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span><span class="s1">&#39;endtime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="p">:</span> <span class="n">ts</span><span class="p">}</span> <span class="p">}</span>
<span class="p">]</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_miniseed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">ens</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="s1">&#39;wf_miniseed&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That is a complex query by any definition, but it illustrates several
features of MQL, some of which are new and some of which were discussed earlier:</p>
<ol class="arabic simple">
<li><p>The dictionary of this key uses both attribute names
(‘net’,’sta’,’chan’, and ‘loc’) and an operator (‘$and’).</p></li>
<li><p>The four attribute keys defined implied == (equality) matches on the
seed channel code keywords.  As noted above there is an implied logical
AND between the four seed station code matching components. (The “$and”
is different.)</p></li>
<li><p>Notice the subtle detail that the ‘$and’ operator key is associated with
a python list (implied by the [] symbols) instead of a python dict
or simple value like all previous examples.   The logical AND is
applied to all components of the list.  This example has two components
but it could be as many as needed.   The components of the list are
MQL dictionary expressions that resolve True or False.</p></li>
<li><p>This example shows the application of a query to create a cursor
passed to the <cite>read_data</cite> method of <cite>Database</cite>.   That is the standard
way in MsPASS to get a bundle of data we call a <cite>TimeSeriesEnsemble</cite>.
In this case, the ensemble will contain all waveform segments for the LHZ
channel of the IRIS-Ida station PFO (loc code 00) that have any samples
recorded in the month of June 2012.</p></li>
</ol>
<p>A final point for this section is another shorthand allowed in the MQL
language.   That is, the “$and” operator above is not actually required.
The same query as above could, in fact, have been written as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;net&#39;</span> <span class="p">:</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span>
  <span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;PFO&#39;</span><span class="p">,</span>
  <span class="s1">&#39;chan&#39;</span> <span class="p">:</span> <span class="s1">&#39;LHZ&#39;</span><span class="p">,</span>
  <span class="s1">&#39;loc&#39;</span> <span class="p">:</span> <span class="s1">&#39;00&#39;</span><span class="p">,</span>
  <span class="p">{</span><span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lte&#39;</span> <span class="p">:</span> <span class="n">te</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span><span class="s1">&#39;endtime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="p">:</span> <span class="n">ts</span><span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this case I used the inline syntax because it more clearly shows
the point.  That is, a query defined by a series of expressions has
an implied “AND” logical operator for all separate expressions.
For this example, you would say that in words as:
net code is II AND sta code is PFO AND channel code is LHZ AND …
For that reason the used of the $and opertor above is not actually
required.  Note, however, if an query logical expression involves
an OR clause the list of expressions syntax is required.  Here,
for example, is a similar query to above with an OR clause.
This query would always retrieve horizontal components and handle the
obnoxious channel code variation of E,N,Z naming versus 1,2,Z naming.
It also drops the “loc” matching and would thus ignore the loc code
and retrieve data from all sensors at PFO.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;net&#39;</span> <span class="p">:</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span>
  <span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;PFO&#39;</span><span class="p">,</span>
  <span class="s1">&#39;$or&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;chan&#39;</span> <span class="p">:</span> <span class="s1">&#39;LHE&#39;</span><span class="p">,</span> <span class="s1">&#39;chan&#39;</span> <span class="p">:</span> <span class="s1">&#39;LHN&#39;</span><span class="p">,</span> <span class="s1">&#39;chan&#39;</span> <span class="p">:</span> <span class="s1">&#39;LH1&#39;</span><span class="p">,</span> <span class="s1">&#39;chan&#39;</span> <span class="p">:</span> <span class="s1">&#39;LH2&#39;</span><span class="p">],</span>
  <span class="p">{</span><span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lte&#39;</span> <span class="p">:</span> <span class="n">te</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span><span class="s1">&#39;endtime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="p">:</span> <span class="n">ts</span><span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, the previous example also can be used to illustrate a
clearer solution with the <cite>$regex</cite> operator.   Most $or clauses I’ve
encountered are easier to express with a regular expression.
The above could thus be express equivalently with this one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;net&#39;</span> <span class="p">:</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span>
  <span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;PFO&#39;</span><span class="p">,</span>
  <span class="s1">&#39;chan&#39;</span> <span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;$regex&#39;</span> <span class="p">:</span> <span class="s1">&#39;LH.&#39;</span><span class="p">},</span>
  <span class="p">{</span><span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lte&#39;</span> <span class="p">:</span> <span class="n">te</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span><span class="s1">&#39;endtime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="p">:</span> <span class="n">ts</span><span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="geospatial-queries">
<h3>Geospatial queries<a class="headerlink" href="#geospatial-queries" title="Permalink to this heading"></a></h3>
<p>MongoDB has a fairly sophisticated geospatial querying feature.
A first order thing you must realize about geospatial indexing is that
to be useful two things are required:</p>
<ol class="arabic simple">
<li><p>The attribute(s) you want to query should be structured into a
special data type called a
<a class="reference external" href="https://www.mongodb.com/docs/manual/geospatial-queries/#std-label-geospatial-geojson">GeoJSON object</a>.
The only example packaged that way by MsPASS is the coordinates of
seismic instruments stored in the “site” and”channel” collections
and source spatial coordinates defined in the standard “source” collection.
For all the “lat” and “lon” keys define the latitude
and longitude directly and are copied stored in a GeoJSON point object
with the key <cite>location</cite> in “site” and “channel” and “epicenter” in “source”.
A limitation of MongoDB’s geospatial query engine is it is much like
ArcGIS and is tuned to coordinate-based queries.  To add a depth
constraint requires a compound query mixing geospatial and a range
query over depth.</p></li>
<li><p>All geospatial queries REQUIRE creating a
<a class="reference external" href="https://www.mongodb.com/docs/manual/core/indexes/index-types/index-geospatial/#std-label-geospatial-index">geospatial index</a>.
Most MsPASS users will ALWAYS want to use what MongoDB calls a
“2dsphere” index.   Their “2d” index uses a map projection and is
designed only for local scale software apps at a city scale.
The “2d” index is not accurate for the scale of most seismology
research problems.  An exception is that UTM coordinates may work
with a “2d” index, but I have no direct experience
with that approach.  That could be useful with active source data
where survey coordinates are use UTM coordinates.</p></li>
</ol>
<p>The most common usage for geespatial queries I know in seismology is
limiting the set of seismic instruments and/or sources based on a
geographical area.   MQL implements geospatial queries as
a special type of operator.  i.e. the definitions of the query
are used like ‘$gt’, ‘$eq’, etc.</p>
<p>Here is a simple example to retrieve documents from the site collection
for all stations within 500 km of my home in Bloomington, Indiana.
It is a minor variant of a similar example in the tutorial linked to
this page.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:{</span>
      <span class="s1">&#39;$nearSphere&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">&#39;$geometry&#39;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;Point&#39;</span><span class="p">,</span>
              <span class="s1">&#39;coordinates&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">86.5264</span><span class="p">,</span> <span class="mf">39.1653</span><span class="p">]</span>
          <span class="p">},</span>
          <span class="s1">&#39;$maxDistance&#39;</span> <span class="p">:</span> <span class="mf">500000.0</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the complex, nested operators that characterize all MongoDB
geospatial queries.   I trust the verbose names make clear how this
query works provided you realize the location of Bloomington is
around 39 degrees latitude and the distance parameters have to
be defined in meters.   Note a few key details:</p>
<ol class="arabic simple">
<li><p>MQL’s geospatial query language is best done with
<a class="reference external" href="https://geojson.org/">geoJSON</a>.  This example defines a
geoJSON point
and a search radius.  In all cases, the key at the top level of
the query is an MQL operator.   In this case the operator is
“$nearSphere”.  Note the first character “$” that is universally
used to define a key as an operator in MQL. This example is
a typical geospatial query made up of a multi-level document/dictionary
with multiple operators at different levels.</p></li>
<li><p>The distance specification is in meters and the geographical
coordinate data are in degrees.  As far as I can tell that is the
norm for MongoDB.  (Some older sources suggest some operators
once used radian units, but that seems to be the distant past.)</p></li>
<li><p>Once constructed the query is used like any other dictionary
passed to find.  This example doesn’t use any projection to
keep the example simple, but it could have.</p></li>
</ol>
<p>The set of spatial query operators are document in
<a class="reference external" href="https://www.mongodb.com/docs/manual/reference/operator/query-geospatial/">this page</a>
of the MongoDB documentation.  Most of the complexity is in the
second level of attributes passed to the operator specified in geoJSON.
That is, for spherical geometry, which I again stress is the only thing
you should use, there are only three operator:
(1) <cite>nearSphere</cite> that I illustrated above, and (2) <cite>geoWithin</cite>
used to search inside a specified geometric shape (e.g. a polygon
but can be other things), and (3) <cite>geoIntersects</cite> that
“selects documents whose geospatial data intersects with a specified GeoJSON object …”.</p>
<p>Although the spatial query operators are a powerful tool to allow
geospatial queries comparable to some elements of a GIS system, there
are some major caveats and warnings:</p>
<ol class="arabic">
<li><p>It is quite clear that the geospatial features of MongoDB
have evolved significantly in recent years.
Why that matters is I find a lot of online sources
contain out-of-date information.
To make matters worse, MongoDB’s documentation on the topic
does a poor job of describing this evolution
and older documentation has examples that I found wouldn’t work.
That may change, but be warned you are likely in for some hacking.</p></li>
<li><p>From what I can glean from fighting with this feature, the
current problem was created by a evolution of MongoDB that seems to
have begun around 2020.   It appears the earliest attempts to add
geospatial queries to MongoDB used a “legacy” format to define
coordinates.  e.g. a specific lon-lat can be specified in “legacy”
format like this:<cite>{ “coords” : [-102.7724, 33.969601]}</cite>.   The same
information defined in geoJSON is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;coords&quot;</span> <span class="p">:</span>
    <span class="p">{</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
      <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="o">-</span><span class="mf">102.7724</span><span class="p">,</span>
        <span class="mf">33.969601</span>
      <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From my experience you should avoid the legacy format and only use
geoJSON specifications in MongoDB documents.  To make that easier
there is a convenience function in the <cite>mspasspy.db.database</cite>
module called <cite>geoJSON_doc</cite>.   It can be used to create the obscure
document structure MongoDB requires for simple lat,lon point data.</p>
</li>
<li><p>A limitation of the (current) MongoDB implementation is the
<cite>count_documents</cite> method does not seem to work for any valid
query I can construct.  Internet chatter suggests that is the norm.
I have found that using <cite>count_documents</cite> to test a query to
report the size of a query return is a good way to debug complex
queries.  Since all geospatial queries are complex by
almost any definition that is problematic.  I find that to debug
a geospatial query it is helpful to isolate the query in a
jupyter notebook box run it until the query runs without an error.
The example code block immediately above is a good model.
Use the same structure, but remove the print loop until you get the
query to work.</p></li>
</ol>
<p>I would stress that in spite of these caveats, the integration of
geospatial query functions in the MongoDB are an important functionality
that can simplify a lot of research workflows.  If your work requires
any kind of geospatial grouping, it is worth investing the effort to
understand MongoDB’s geospatial operators and how we use them in MsPASS.</p>
</section>
<section id="sorting">
<h3>Sorting<a class="headerlink" href="#sorting" title="Permalink to this heading"></a></h3>
<p>There are many situations where an algorithm using input from
a MongoDB query requires a list sorted by one or more keys.
Defining a sort is straightforward but a little bit weird
until you understand the logic.   It will be easier to
explain that with a simple example.   Here is a query that returns
a cursor to retrieve documents defining LHZ waveforms from
station PFO (it uses a duplicate of one of the compound queries
from above) but this time we sort the result by starttime
(a type example of a sort requirement):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ts and te are epoch times defing the time range as above</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;net&#39;</span> <span class="p">:</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span>
  <span class="s1">&#39;sta&#39;</span> <span class="p">:</span> <span class="s1">&#39;PFO&#39;</span><span class="p">,</span>
  <span class="s1">&#39;chan&#39;</span> <span class="p">:</span> <span class="s1">&#39;LHZ&#39;</span><span class="p">,</span>
  <span class="s1">&#39;loc&#39;</span> <span class="p">:</span> <span class="s1">&#39;00&#39;</span><span class="p">,</span>
  <span class="p">{</span><span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$le&#39;</span> <span class="p">:</span> <span class="n">te</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span><span class="s1">&#39;endtime&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$ge&#39;</span> <span class="p">:</span> <span class="n">ts</span><span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_miniseed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;starttime&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ens</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="s1">&#39;wf_miniseed&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>There are two key points this example illustrates:</p>
<ol class="arabic simple">
<li><p><cite>sort</cite> is defined as a “method” of the “Cursor” object returned by find.
That is more than a little
weird but a common construct in python which is an object-oriented language.
Most of us can remember it better by just thinking of it as an clause
added after find and separated by the “.” symbol.  Because it is a method
of cursor the sort clause could have been expressed as another statement
after the find like this:  <cite>cursor = cursor.sort(“starttime,1)”)</cite></p></li>
<li><p>The sort expression for a single key can be thought of as calling a
function with two arguments.  The first it the key to use for the
sort and the second defines the direction of the sort. Here I
used “1” which means sort into an ascending sequence.  When the result is
passed to the <cite>read_data</cite> it guarantees the waveforms in the
ensemble created by <cite>read_data</cite> will be in increasing starttime order.
You would use -1 if you wanted to sort in descending order.
(Note:  some sources will use the verbose symbols <cite>pymongo.ASCENDING</cite>
instead of 1 and <cite>pymongo.DESCENDING</cite> instead of -1.  For me 1 and -1
are a lot easier to remember.)   In typical python way there is also
a default for the sort order of 1.  i.e. in the sort call above
we could have omitted the second argument.</p></li>
</ol>
<p>Sorting on multiple keys requires a slightly different syntax.   Again, an
example will make this clearer. This code segment prints a report for
the entire contents of the channel collection sorted by seed channel code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sort_clause</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="s2">&quot;net&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="s2">&quot;sta&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="s2">&quot;chan&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="s2">&quot;starttime&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort_clause</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;net sta chan loc starttime&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="c1"># conditional to handle common case with loc undefined</span>
  <span class="k">if</span> <span class="s1">&#39;loc&#39;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">],</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">],</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;chan&#39;</span><span class="p">],</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">],</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">],</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;chan&#39;</span><span class="p">],</span><span class="s1">&#39;UNDEFINED&#39;</span><span class="p">,</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>The main thing to notice is that when using multiple keys for a sort they
must be defined as a python list of python tuples (arrays defined with [] will
also work).  That usage is potentially confusing for two reasons you should
be aware of:</p>
<ol class="arabic simple">
<li><p>Most examples you will see of a single key sort use just the key name
(ascending order is the default) or two arguments version like that I used
above.   Multiple key sorts require a completely different type for arg0;
a python list of tuples.</p></li>
<li><p>Most examples you will find in a routine internet search with a phrase
like “mongodb sort with mutiple keys” will show the syntax you can use
with the “mongo shell”.   The problem is that the mongo shell speaks
a different language (Javascript) that uses a syntax that looks like
it is defining an inline python dictionary definition, but it is not.
That is, with
the mongo shell the sort above could be written as:
<cite>{‘net’:1, ‘sta’:1, ‘chan’:1, ‘starttime’:1}</cite>.  That is not a python
dictionary, however, even though the syntax is exactly the same.
In Javascript that is a list where the order of the list means something.
If that were translated to a python dictionary it would not work
because order of input is not preserved in a python dictionary.  Hence,
the pymongo API has to use a list to preserve order.</p></li>
</ol>
</section>
<section id="report-generators">
<h3>Report generators<a class="headerlink" href="#report-generators" title="Permalink to this heading"></a></h3>
<p>One of the important applications of queries in MsPASS is to generate
a human readable report on the content of a database that is to be used
as input for processing.  An option for experienced programmers familiar with the
incantations of detailed formatting of text output is to create a
custom formatting function to generate a report from a cursor input.
For mere mortals, however, there are two much simpler options:</p>
<ol class="arabic simple">
<li><p>For small numbers of documents the <cite>json_util</cite> package can be useful.</p></li>
<li><p>Pandas are your friend for producing output visualized well with a table.</p></li>
</ol>
<p>The examples in this section show how to set up both.  The related tutorial
notebook for this section of the User’s Manual provide hands on examples
and why raw output can be ugly.</p>
<p>A typical example of <cite>json_util</cite> is that you might want to look at the gross
structure of one or more documents created by running something like the
MsPASS <cite>index_mseed_file</cite> method of <cite>Database</cite>.   Something like the
following can be useful to use in a python notebook run interactively
to work out data problems:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">json_util</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_miniseed</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json_util</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>The <cite>indent=2</cite> argument is essential to create an output that is
more readable than what would be otherwise produced by the much
simpler to write expression <cite>print(doc)</cite>.</p>
<p>Many quality control reports are conveniently visualized with a well
formatted table display.  As noted above pandas are your friend in
creating such a report.  Here is an example that creates a report of all
stations listed in the site collection with coordinates and the time
range of recording.  It is a variant of a code block in our
MsPASS <a href="#id1"><span class="problematic" id="id2">`mongodb_tutorial&lt;&gt;`__</span></a> (TODO:  hyperlink to github )</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">cursor</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="n">doclist</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="c1"># Not essential, but produces a more readable table with date strings</span>
  <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">])</span>
  <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">])</span>
  <span class="n">doclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">doclist</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="saves-create-of-crud">
<h2>Saves (Create of CRUD)<a class="headerlink" href="#saves-create-of-crud" title="Permalink to this heading"></a></h2>
<p>The first letter of CRUD is the save operation.   A save of some kind
is usually the first thing one does in building a seismic dataset
as there needs to be some what to populate the database collections.
Our “getting_started” tutorial illustrates the most common
workflow:  populating the “site”, “channel”, “source”, and (usually)
“wf_miniseed”.   This section focuses more on the general problem of
loading some other data that doesn’t match the standard mspass schema.
An example, which we use for the hands on supplement to this section
in our notebook tutorials, is downloading and loading the current CMT
catalog and loading it into a nonstandard collection we all “CMT”.
In this manual we focus on the fundamentals of the pymongo API for
saving documents.</p>
<p>There are two methods of <cite>Database.collection</cite> that you can use to
save “documents” in a MongoDB collection.  They are:</p>
<ol class="arabic simple">
<li><p><cite>insert_one</cite> as the name implies is used to save on and only
one document.   It is usually run with one argument that is assumed
to be a python dictionary containing the name-value pairs that
define the document to be saved and subsequently managed by
MongoDB.</p></li>
<li><p><cite>insert_many</cite> is used to insert multiple documents.  It expects
to receive a python list of dictionaries as arg0 each of which is
like input sent to <cite>insert_one</cite>.</p></li>
</ol>
<p>An important thing to realize is that <cite>insert_many</cite> is not at all
the same thing as running a loop like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wrong way to do insert_many</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doclist</span><span class="p">:</span>
  <span class="n">db</span><span class="o">.</span><span class="n">CMT</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
<p>The reason is that the loop above does an independent transaction for
each document and the loop blocks until the MongoDB server acknowledges
success.   <cite>insert_many</cite>, in contrast, does a bulk update.   It automatically
breaks up the list into chunk sizes it handles as one transaction.
With a large save <cite>insert_many</cite> can be orders of magnitude faster
than the same number of one-at-a-time transactions.</p>
<p>Here is a partial example of save from the related tutorial notebook:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">doclist</span> <span class="o">=</span> <span class="n">ndk2docs</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of CMT records in file=&quot;</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39; is &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">doclist</span><span class="p">))</span>
<span class="n">r</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">CMT</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">doclist</span><span class="p">)</span>
<span class="n">n</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">CMT</span><span class="o">.</span><span class="n">count_documents</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of documents in CMT collection is now &quot;</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="updates-u-of-crud">
<h2>Updates (U of CRUD)<a class="headerlink" href="#updates-u-of-crud" title="Permalink to this heading"></a></h2>
<p>Updates have a similar API to the insert/create API.  That is, there
are again two different collection methods:</p>
<ol class="arabic simple">
<li><p><cite>update_one</cite> is used to replace all or some of the data in one document.</p></li>
<li><p><cite>update_many</cite> is used to replace all or some attributes of many documents
in a single transaction.</p></li>
</ol>
<p>There is, however, a special feature called a <cite>bulk_write</cite> that can be useful
in some situations.   I cover that more specialized function at the end of
this section.</p>
<p>Although they have options, both <cite>update_one</cite> and <cite>update_many</cite>
are usually called with two arguments. <em>arg0</em> is an MQL matching query and
<em>arg1</em> defines what is to be changed/added.   The only real difference
between <cite>update_one</cite> and <cite>update_many</cite> is that <cite>update_one</cite> will only
change the first occurence it finds if the match query is not unique.
For that reason, <cite>update_one</cite> is most commonly used with an <cite>ObjectId</cite>
match key.  For example, this segment would be a (slow) way to add
a cross-reference id link to wf_TimeSeries documents with
documents from a channel collection produced
created by loading from an Antelope sitechan table.  It uses the foreign
key “chanid” in CSS3.0 to find a record and then uses <cite>update_one</cite> to
set the MsPASS standard cross-reference name <cite>channel_id</cite> in wf_TimeSeries.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># some previous magic has been assumed to have set chanid in</span>
<span class="c1"># wf_TimeSeries (feasible with a CSS3.0 wfdisc table)</span>
<span class="c1"># This examplei is for illustration only and is not of direct use</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_TimeSeries</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="k">if</span> <span class="s1">&#39;chanid&#39;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
    <span class="n">chandoc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">&#39;chanid&#39;</span> <span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;chanid&#39;</span><span class="p">]})</span>
    <span class="c1"># find_one failures return None so this is a test for a valid return</span>
    <span class="k">if</span> <span class="n">chandoc</span><span class="p">:</span>
      <span class="n">cid</span> <span class="o">=</span> <span class="n">chandoc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
      <span class="n">wfid</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
      <span class="n">db</span><span class="o">.</span><span class="n">wf_TimeSeries</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span> <span class="p">:</span> <span class="n">wfid</span><span class="p">},{</span><span class="s1">&#39;channel_id&#39;</span> <span class="p">:</span> <span class="n">cid</span> <span class="p">})</span>
</pre></div>
</div>
<p>The <cite>update_many</cite> method is more commonly used with more complex queries
to set a constant for the group of documents.  The example below uses
<cite>update_many</cite> to build source cross-reference ids for a dataset created
by extracting waveforms using event origin times as the start times.
We can then do a match (arg0) using a range test with a small tolerance
around the origin time.  This fragment, unlike the <cite>update_one</cite> example,
is a useful prototype for a common organization of a dataset that initiates
from common source gathers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define a +- range relative to origin time for starttime</span>
<span class="n">ot_range</span><span class="o">=</span><span class="mf">1.0</span>
<span class="c1"># loop over all source records to drive this process</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="n">otime</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
  <span class="n">ts</span> <span class="o">=</span> <span class="n">otime</span> <span class="o">-</span> <span class="n">ot_range</span>
  <span class="n">te</span> <span class="o">=</span> <span class="n">otime</span> <span class="o">+</span> <span class="n">ot_range</span>
  <span class="n">match_query</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;starttime&#39;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="p">{</span><span class="s1">&#39;$gte&#39;</span>  <span class="n">ts</span><span class="p">,</span> <span class="s1">&#39;$lte&#39;</span> <span class="p">:</span> <span class="n">te</span><span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">srcid</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>  <span class="c1"># ObjectId of this source document</span>
  <span class="n">update_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source_id&#39;</span> <span class="p">:</span> <span class="n">srcid</span><span class="p">}</span>
  <span class="n">db</span><span class="o">.</span><span class="n">wf_TimeSeries</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span><span class="n">match_query</span><span class="p">,</span><span class="n">update_doc</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, a more advanced approach that is useful for large numbers of
random updates with a large data set is the pymongo collection method
called <a class="reference external" href="https://pymongo.readthedocs.io/en/stable/examples/bulk.html">bulk_write</a>.
An example of how to use this method can be found in the MsPASS function
<a class="reference external" href="https://github.com/mspass-team/mspass/blob/master/python/mspasspy/db/normalize.py">bulk_normalize</a>.
Briefly, the idea is to manually build up blocks of atomic-level updates.
That approach is necessary only in the case where there is no simple
recipe for creating smaller number of matching operators like my
<cite>insert_many</cite> example above.  That is, the <cite>bulk_normalize</cite> function uses
does unique matches for each wf document with an object_id.   It makes
sense in that context because it assumes the matching was done externally
with one of the MsPASS matchers.</p>
</section>
<section id="delete-d-of-crud">
<h2>Delete (D of CRUD)<a class="headerlink" href="#delete-d-of-crud" title="Permalink to this heading"></a></h2>
<p>As noted elsewhere, we take the position that for most design uses
of MsPASS delete operations should be rare.  To reiterate, the reason
is that MsPASS was designed with the idea that the database is used
to manage an assembled data set.  Appending more data is expected to
be the norm, but deleting data unusual.  For most cases, for example,
it is easier to rebuild something like a <cite>wf_miniseed</cite> collection
than design a deletion operation to selectively remove some data.
Nonetheless, that statement motivates the example we give below.</p>
<p>The API for deletion has a strong parallel to insert and update.  That is,
there are two basic method:  <cite>delete_one</cite> deletes one document and
<cite>delete_many</cite> can be used to delete a set of documents matching a
query defined with arg0.</p>
<p>As an example, suppose we have a large dataset assembled into Seismogram
objects indexed with <cite>wf_Seismogram</cite> and we find station “XYZ” had
something fundamentally wrong with it for the entire duration of the
dataset.   Assume “XYZ” doesn’t require a “net” qualifier to be unique
this code fragment could be used to delete all entries for “XYZ”.
It is complicated by a bit by the fact that multiple site entries can
occur for the same station due to time-dependent metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;sta&#39;</span><span class="p">:</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">})</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="n">sid</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
  <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;site_id&#39;</span> <span class="p">:</span> <span class="n">sid</span><span class="p">}</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">wf_Seismogram</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of documents to be deleted for station XYZ =&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;for time period &quot;</span><span class="p">,</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]),</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]))</span>
  <span class="n">db</span><span class="o">.</span><span class="n">wf_Seismogram</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="indexes">
<h2>Indexes<a class="headerlink" href="#indexes" title="Permalink to this heading"></a></h2>
<p>An index is desirable in any database system to improve read performance.
Without an index a query requires a linear search through the entire
database to find matching records.  As a result read and update performance on
any database system can be improved by orders of magnitude with a properly
constructed index.   On the other hand, an indexes can slow write performance
significantly.  I have found that in data processing with MsPASS the main
application of indexes is to normalizing collections.   They fit the
constraint above.  That is, normalizing data is normally written once with
occasional updates and is mostly used during read operations.</p>
<p>A first point to recognize is that MongoDB ALWAYS defines an index on the
magic attribute key “_id” for any collection.   Any additional
index needs to be created with the collection method called
<a class="reference external" href="https://pymongo.readthedocs.io/en/stable/api/pymongo/collection.html">create_index</a>.
The index can be defined for one or more keys and set to define an
increasing or decreasing sequence.   e.g. the following will create an
index on the channel collection appropriate for miniseed metadata
that require at least the four keys used to provide a unique match:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span>
 <span class="p">[</span>
  <span class="s2">&quot;net&quot;</span><span class="p">,</span>
  <span class="p">(</span><span class="s2">&quot;sta&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">),</span>
  <span class="s2">&quot;chan&quot;</span><span class="p">,</span>
  <span class="s2">&quot;time&quot;</span>
 <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note arg0 is a list of attribute names and/or 2-element tuples.
Tuples are needed only if the default ascending order is to be
switch to descending.  I did that for illustration above for “sta”,
but it wouldn’t normally be necessary.</p>
<p>There are two utility functions for managing indexes in a collection:</p>
<ol class="arabic simple">
<li><p><cite>list_indexes</cite> returns a <cite>Cursor</cite> that can be iterated
to show details of all indexes defined for a collection.  e.g. the
above section to create a special index for channel might be
followed by this line to verify it worked:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">list_indexes</span><span class="p">()</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">json_utils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>There is a <cite>delete_index</cite> that can be used to remove an index from
a collection.  It uses the index name that is returned on creation
by <cite>create_index</cite> or can be obtained by running <cite>list_indexes</cite>.</p></li>
</ol>
<p>A final point about indexes is special case of “geospatial indexes”
discussed above.   A geospatial index is a very different thing than
a “normal” index on one or more keys.   Consult online sources if
you need to learn more about that topic.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CRUD_operations.html" class="btn btn-neutral float-left" title="CRUD Operations in MsPASS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="normalization.html" class="btn btn-neutral float-right" title="Normalization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, Ian Wang.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>