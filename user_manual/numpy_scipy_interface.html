<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using numpy/scipy with MsPASS &mdash; MsPASS 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=f6245a2f"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using ObsPy with MsPASS" href="obspy_interface.html" />
    <link rel="prev" title="Data Object Design Concepts" href="data_object_design_concepts.html" />  

  <style>
    .wy-nav-content { max-width: 1600px; }
  </style>

  
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MsPASS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/quick_start.html">Getting Started in a Nutshell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/run_mspass_with_docker.html">Run MsPASS with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/deploy_mspass_with_docker_compose.html">Deploy MsPASS with Docker Compose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/deploy_mspass_on_HPC.html">Deploying MsPASS on an HPC cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started_overview.html">MsPASS Virtual Cluster Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="database_concepts.html">Database Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="CRUD_operations.html">CRUD Operations in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongodb_and_mspass.html">Using MongoDB with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="normalization.html">Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="importing_tabular_data.html">Importing Tabular Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Seismic Data Objects</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_object_design_concepts.html">Data Object Design Concepts</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using numpy/scipy with MsPASS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#timeseries-data">TimeSeries Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#seismogram-data">Seismogram Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="obspy_interface.html">Using ObsPy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="time_standard_constraints.html">Time Standard Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_history_concepts.html">Processing History Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="continuous_data.html">Continuous Data Handling with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema_choices.html">What database schema should I use?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="importing_data.html">Importing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="handling_errors.html">Handling Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_editing.html">Data Editing</a></li>
<li class="toctree-l1"><a class="reference internal" href="header_math.html">Header (Metadata) Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="graphics.html">Graphics in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal_to_noise.html">Signal to Noise Ratio Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="adapting_algorithms.html">Adapting an Existing Algorithm to MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">System Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parallel_processing.html">Parallel Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory_management.html">Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="io.html">I/O in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel_io.html">Parallel IO in MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequency Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_strategies.html">How do I develop a new workflow from scratch?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cxx_api/index.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mspass_schema/mspass_schema.html">MsPASS Schema</a></li>
</ul>

    <a href= "../genindex.html">Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MsPASS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Using numpy/scipy with MsPASS</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mspass-team/mspass/blob/master/docs/source/user_manual/numpy_scipy_interface.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="using-numpy-scipy-with-mspass">
<span id="numpy-scipy-interface"></span><h1>Using numpy/scipy with MsPASS<a class="headerlink" href="#using-numpy-scipy-with-mspass" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>The <cite>numpy</cite> and <cite>scipy</cite> packages are heavily utilized for scientific computing
in a wide range of fields.   One of the reasons for that is performance.
For a number of reasons that are beside the point, python arrays
have horrible performance.  That is particularly true of linear algebra
operations common in all signal processing algorithms.
All numpy algorithms we’ve ever tested are orders of magnitude faster than the same
algorithm implemented as a pure python code with python arrays.  Since most
scipy algorithms are built on top of numpy, the same holds for scipy.
Similarly, obspy uses numpy arrays exclusively.   As a result, an early
design constraint in MsPASS was to provide as clean an interface to
numpy/scipy as possible.  However, because we chose to implement our own
core data objects in C++, that presents a disconnect that causes a few
anomalies in the MsPASS API.  This section of the User’s Manual
documents these issues and provides guidance for how to effectively mix
numpy/scipy algorithms with <cite>TimeSeries</cite>, <cite>Seismogram</cite>, and ensemble objects.
It does not address a prototype data type we call a <cite>Gather</cite> that can be used
for uniform ensembles.  The <cite>Gather</cite> object is a pure python class that uses
multidimensional numpy arrays to store sample data and is not subject to
the issues addressed in this section.</p>
</section>
<section id="timeseries-data">
<h2>TimeSeries Data<a class="headerlink" href="#timeseries-data" title="Permalink to this heading"></a></h2>
<p>Recall the mspass <cite>TimeSeries</cite> class is used to abstract the concept of
a single channel of fixed sample rate seismic data spanning a given time period.
As such we used the standard signal processing abstraction of storing
the data as a vector of numbers.</p>
<p>Every computing language that has any role in numerical computing defines
a syntax for arrays.  A vector in this context is a one-dimensional array.
A problem with python’s builtin array is that it isn’t actually at all the
same thing as an array in FORTRAN of C.   Both FORTRAN and C define
an array as a fixed block of memory of a specified length containing
a sequence of numbers of the same type.   (e.g. a C double array of length
10 is a block of <span class="math notranslate nohighlight">\(8*10\)</span> bytes.)  Numpy performance is achieved by
redefining an array to assume the data are in a contiguous memory block and
using wrappers that allow low-level operations to actually be performed
by compiled C or FORTRAN functions.  We do the same thing in MsPASS
but our data objects do not contain numpy array classes per se, but
we use the same approach to allow low-level operations to be
done in C++.  Because we use the same concept (arrays are contiguous
blocks of memory) the arrays can mostly be used interchangeably, but
not always.</p>
<p>So what is the difference?   If you execute this code fragment in MsPASS:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mspasspy.ccore.seismic</span> <span class="kn">import</span> <span class="n">TimeSeries</span>
<span class="n">x_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x_mspass</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Type of numpy object=&quot;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">x_numpy</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Type of mspass data vector=&quot;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<p>You should get this output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>Type of numpy object= &lt;class &#39;numpy.ndarray&#39;&gt;
Type of mspass data vector= &lt;class &#39;mspasspy.ccore.seismic.DoubleVector&#39;&gt;
</pre></div>
</div>
<p>The point is that both define two conceptually similar things that are a
vector of sample data.  In this example
these are stored with the symbols <cite>x_numpy</cite> a <cite>x_mspass.data</cite>.
The print statements emphasize they are
different data types.  They are not, however, an apples and oranges
kind of comparison but more of a Jonathan versus Gala apple comparison.
Python is very cavalier about type.  Many sources call this “duck typing”
from the cliche “if it walks like a duck and quacks like duck it must be duck”.
Because of “duck typing” we can, in most cases, interchange the use of the
two classes <cite>ndarray</cite> and <cite>DoubleVector</cite>.
For example, you can nearly always send <cite>DoubleVector</cite> data to a
numpy or scipy function and it will work just find.  Here are a few
examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="c1"># Setting data to nonzero values - not essential but otherwise</span>
<span class="c1"># trivial zero vector will cause problems for the log example</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">npts</span><span class="p">):</span>
  <span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">yh</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">hilbert</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>That works because the <cite>DoubleVector</cite> is what numpy’s documentation
calls “array like” (a duck type concept).  In fact, any numpy or scipy
function that accepts an “array like” argument can accept the <cite>data</cite>
member of a <cite>TimeSeries</cite> and work.   In reality, <cite>DoubleVector</cite> is
a C++ “vector container” that in C++ would be declared as:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
</pre></div>
</div>
<p>In MsPASS we use stock “bindings” from pybind11 that allow us to do
this magic.  The real magic is that in most cases no copying of the
array data is required.   (For C programmers the bindings use
a pointer (address) not a copy.)</p>
<p>This magic works for most, but not necessarily all, vector operators that
mix <cite>DoubleVector</cite> and <cite>ndarray</cite> types.  e.g. with the symbols above defined
all of the following will work and do what is expected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="o">=</span><span class="n">x_numpy</span><span class="o">-</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span>
<span class="n">z</span><span class="o">=</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="n">x_numpy</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="n">z</span>
<span class="n">z</span><span class="o">=</span><span class="n">x_numpy</span><span class="o">*</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># a peculiar numpy operation - not a dot product</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mf">10.0</span>
</pre></div>
</div>
<p>The main thing to avoid is an assignment where the left hand side
and right hand side resolve to different types.   For instance,
the following will fail with a <cite>TypeError</cite> exception if you try to run it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">x_numpy</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">x_numpy</span> <span class="o">+</span> <span class="n">z</span>
</pre></div>
</div>
<p>The solution is to use a python version of a type cast to a <cite>DoubleVector</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DoubleVector</span><span class="p">(</span><span class="n">x_numpy</span><span class="p">)</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DoubleVector</span><span class="p">(</span><span class="n">x_numpy</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
<p>That is necessary because in both cases the right hand side is an
<cite>ndarray</cite>.  The construct used is a call to the bindings of a copy constructor
for the C++ std::vector container so it seems to come at the cost of a memory copy.
On the other hand, that is orders of magnitude faster than a python loop to do the
same operations.</p>
<p>Be aware that if you mix types in a vector operation you can get some surprising
results.   For example, the following code will generate a <cite>TypeError</cite>
exception:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">=</span><span class="n">TimeSeries</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<p>while simply reversing the order of <cite>z</cite> and <cite>ts.data</cite> like this</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">=</span><span class="n">TimeSeries</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">z</span>
</pre></div>
</div>
<p>works and does set <cite>x_mspass.data</cite> to the vector sum of the two symbols
on the right hand side.  The reason is that the + operator in python
seems to resolve the type to the type of the left side of the + operator.
Why is “deep in the weeds”, but the best advice is to avoid mixed type
operations if possible.  The more robust way to write the above as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">=</span><span class="n">TimeSeries</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DoubleVector</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, users who are matlab fans may like to write python code using
the vector “:” operator.  For example, with numpy functions operations like the
following are commonly used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>That will print “5” - the length of the subvector extracted in x.
The : operator does not always work with a <cite>DoubleVector</cite>.  If you have an
algorithm using the colon operator, do the vector operations with
numpy and then copy the result into the <cite>TimeSeries</cite> data member.
An important warning about any such assignments to <cite>TimeSeries.data</cite> is you
MUST be sure the size of the vector on the right hand side is the
same size as the left hand side.   Consider this segment:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">TimeSeries</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># creates data vector 100 samples long</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
<span class="n">ts</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DoubleVector</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<p>The output of this is “5” showing that, as expected, ts.data is replaced
by the subvector x.  The BIG PROBLEM that can cause is it will create an
inconsistency in the size set by the <cite>npts</cite> attribute of <cite>TimeSeries</cite>.  The
correct solution for the above is this minor variant calling the <cite>set_npts</cite> method
of <cite>TimeSeries</cite></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">TimeSeries</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># creates data vector 100 samples long</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">x</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
<span class="n">ts</span><span class="o">.</span><span class="n">set_npts</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DoubleVector</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<section id="seismogram-data">
<h3>Seismogram Data<a class="headerlink" href="#seismogram-data" title="Permalink to this heading"></a></h3>
<p>MsPASS uses a different data type to hold data from three-component sensors.
The motivation is described in the section titled
<a class="reference internal" href="data_object_design_concepts.html#data-object-design-concepts"><span class="std std-ref">Data Object Design Concepts</span></a>.
The result is that the array holding the sample data is a matrix
instead of a vector.  Some implementation details of note are:</p>
<ol class="arabic simple">
<li><p>In MsPASS the matrix has 3 rows and <cite>npts</cite> columns.  That means the
rows of the matrix an be extracted to create a <cite>TimeSeries</cite>
subset of the data while the columns are single “vector” samples
of ground motion.</p></li>
<li><p>Currently MsPASS uses a simple, lightweight matrix class to store the sample
data called <a class="reference internal" href="../python_api/mspasspy.ccore.html#mspasspy.ccore.utility.dmatrix" title="mspasspy.ccore.utility.dmatrix"><code class="xref py py-class docutils literal notranslate"><span class="pre">mspasspy.ccore.utility.dmatrix</span></code></a>.  A key reason we
made that choice was control over methods defined for the class.  A
case in point is the <cite>shape</cite> attribute that we will see momentarily
is important for working with numpy.</p></li>
<li><p>For performance <cite>dmatrix</cite> is implemented in C++.   The class has methods
for all standard matrix operations with python bindings for those operator.
The corollary to that statement is that when working with <cite>Seismogram</cite> data
use the native operators when possible.</p></li>
<li><p>A <cite>dmatrix</cite> stores the array data in a contiguous block of memory
in what numpy would call “FORTRAN order”. (“C order” is reversed.)
FORTRAN stores a matrix as a contiguous block of memory with the
row index “varying fastest”.  Exchanging the sample data stored
this way with numpy is like that with the std::vector used in
<cite>TimeSeries</cite> but the exchange uses a pointer to the first sample of the
contiguous block of memory held by an instance of a <cite>dmatrix</cite>
class referenced with the symbol <cite>Seismogram.data</cite>.</p></li>
<li><p>We use a variation of the same “magic” in the pybind11 binding code
that allows the <cite>Seismogram.data</cite> matrix to interact cleanly with
numpy and scipy functions that require a matrix.  Like the scalar
case there are impedance mismatches, however, that can complicate
that exchange. We discuss these below.</p></li>
</ol>
<p>Almost all of what was discussed above about using <cite>TimeSeries</cite>
arrays with numpy are similar.  For example, although the result is
meaningless, you can run the following code snippet with
MsPASS and it will run and produce the expected result:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mspasspy.ccore.seismic</span> <span class="kn">import</span> <span class="n">Seismogram</span>
<span class="n">x_mspass</span> <span class="o">=</span><span class="n">Seismogram</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># initialize the matrix to some meaningless, nonzero values</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">npts</span><span class="p">):</span>
     <span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<span class="c1"># these apply the math operation for each number in the data matrix</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># matrix operation that multiplies all samples by 2.0</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mf">2.0</span>
<span class="c1"># matrix operator adding content of numpy matrix z to data matrix</span>
<span class="n">y</span><span class="o">=</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">z</span>
<span class="c1"># matrix operation adding y and x_mspass.data matrices</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">y</span>
<span class="c1"># Same thing done with a binary + operator</span>
<span class="c1"># use a copy to show more likely use</span>
<span class="n">z</span><span class="o">=</span><span class="n">Seismogram</span><span class="p">(</span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">x_mspass_data</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>As with <cite>TimeSeries</cite> at mismatch will occur if the operation
yields a type mismatch.  For example, the following minor variant of
above will run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="o">=</span><span class="n">Seismogram</span><span class="p">(</span><span class="n">x_mspass</span><span class="p">)</span>
<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>In contrast, the following that might seem completely equivalent
will raise a <cite>TypeError</cite> exception:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="o">=</span><span class="n">Seismogram</span><span class="p">(</span><span class="n">x_mspass</span><span class="p">)</span>
<span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
<span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<p>The reason is that for the right hand side resolves to a
numpy “ndarray” and the left hand side is a <cite>dmatrix</cite>.
Exactly like above, this simpler assignment will fail exactly the same way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">y</span>
</pre></div>
</div>
<p>The solution is similar to that we used above for <cite>TimeSeries</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x_mspass</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">dmatrix</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>That is, <cite>DoubleVector</cite> is changed to <cite>dmatrix</cite>.</p>
<p>Finally, the warnings above about the “:” operator with <cite>TimeSeries</cite> apply equally
to <cite>Seismogram</cite>.   If you write a python code with the color operator do
all those operations with numpy arrays and use the <cite>dmatrix</cite> copy constructor
to load the result into the object’s <cite>data</cite> array.   The warning about
making sure the <cite>npts</cite> member attribute is consistent with the result
applies as well.   The only thing to remember with a <cite>Seismogram</cite> is that
<cite>npts</cite> is the number of columns of the data matrix, not the total number of
samples.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="data_object_design_concepts.html" class="btn btn-neutral float-left" title="Data Object Design Concepts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="obspy_interface.html" class="btn btn-neutral float-right" title="Using ObsPy with MsPASS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, Ian Wang.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>