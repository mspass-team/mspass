

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mspasspy.util.Undertaker &mdash; MsPASS 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=f6245a2f"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />  

  <style>
    .wy-nav-content { max-width: 1600px; }
  </style>

  
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MsPASS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quick_start.html">Getting Started in a Nutshell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/run_mspass_with_docker.html">Run MsPASS with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_with_docker_compose.html">Deploy MsPASS with Docker Compose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_with_conda.html">Deploy MsPASS with Conda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_with_conda.html#advanced-setup-considerations">Advanced Setup Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_on_HPC.html">Deploying MsPASS on an HPC cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_with_conda_and_coiled.html">Deploy MsPASS with Conda and Coiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started_overview.html">MsPASS Virtual Cluster Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/database_concepts.html">Database Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/CRUD_operations.html">CRUD Operations in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/mongodb_and_mspass.html">Using MongoDB with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/normalization.html">Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/importing_tabular_data.html">Importing Tabular Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Seismic Data Objects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/data_object_design_concepts.html">Data Object Design Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/numpy_scipy_interface.html">Using numpy/scipy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/obspy_interface.html">Using ObsPy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/time_standard_constraints.html">Time Standard Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/processing_history_concepts.html">Processing History Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/continuous_data.html">Continuous Data Handling with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/schema_choices.html">What database schema should I use?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/algorithms.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/importing_data.html">Importing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/handling_errors.html">Handling Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/data_editing.html">Data Editing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/cleaning_metadata.html">Cleaning Inconsistent Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/header_math.html">Header (Metadata) Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/graphics.html">Graphics in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/signal_to_noise.html">Signal to Noise Ratio Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/adapting_algorithms.html">Adapting an Existing Algorithm to MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">System Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/parallel_processing.html">Parallel Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/memory_management.html">Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/io.html">I/O in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/parallel_io.html">Parallel IO in MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/FAQ.html">Frequency Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/development_strategies.html">How do I develop a new workflow from scratch?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cxx_api/index.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mspass_schema/mspass_schema.html">MsPASS Schema</a></li>
</ul>

    <a href= "../../../genindex.html">Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MsPASS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mspasspy.util.Undertaker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mspasspy.util.Undertaker</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mspasspy.db.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">elog2doc</span><span class="p">,</span> <span class="n">history2doc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymongo</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mspasspy.ccore.seismic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TimeSeries</span><span class="p">,</span>
    <span class="n">Seismogram</span><span class="p">,</span>
    <span class="n">TimeSeriesEnsemble</span><span class="p">,</span>
    <span class="n">SeismogramEnsemble</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mspasspy.ccore.utility</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ErrorSeverity</span><span class="p">,</span>
    <span class="n">MsPASSError</span><span class="p">,</span>
    <span class="n">Metadata</span><span class="p">,</span>
<span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is a class for handling data marked dead.   The method names are a</span>
<span class="sd">programming joke, but are remarkably useful mnemonics for the functionality</span>
<span class="sd">they provide.</span>

<span class="sd">Concepts of this class are:</span>
<span class="sd">1.  Data marked as &quot;dead&quot; in MsPASS are always considered invalid and</span>
<span class="sd">    should not be used as part of a final product that is the goal of a workflow.</span>
<span class="sd">2.  What made the data invalid cannot be known without additional information.</span>
<span class="sd">    In MsPASS the way we always handle adding the additional information is</span>
<span class="sd">    with the ErrorLogger component of all data objects.  Hence, the error</span>
<span class="sd">    log is the way to sort out problems.</span>
<span class="sd">3.  There are two forms of dead data that need to be handled fundamentally</span>
<span class="sd">    differently.   (1) Most dead data are expected to be &quot;killed&quot; by</span>
<span class="sd">    some edit function or a processing algorithm that finds something</span>
<span class="sd">    wrong that won&#39;t allow it to do it&#39;s task.   (e.g. Seismogram objects</span>
<span class="sd">    cannot be created from TimeSeries objects without the orientation</span>
<span class="sd">    angles being defined in the Metadata.)  (2)  Errors created during</span>
<span class="sd">    construction of a data object that cause the construction to fail.</span>
<span class="sd">    The definitive example is constructing seismogram/timeseries objects</span>
<span class="sd">    from the MongoDB representation or while reading from a file can fail</span>
<span class="sd">    for a long list of reasons.  We give the later that colorful name</span>
<span class="sd">    &quot;abortions&quot; since they die before birth.</span>
<span class="sd">4.  Ensembles have more complexity than atomic objects because they are</span>
<span class="sd">    by definition a collection of atomic objects with additional components</span>
<span class="sd">    common to the ensemble.   As a result some methods in this class,</span>
<span class="sd">    notably &quot;bring_out_your_dead&quot; only make sense for ensembles.  There is</span>
<span class="sd">    also the distinction of an ensemble marked dead versus one or more</span>
<span class="sd">    members.  An ensemble marked dead is always treated as having all</span>
<span class="sd">    dead members.</span>

<span class="sd">An additional set of concepts relate to how the undertaker should handle</span>
<span class="sd">the dead bodies.  These are:</span>
<span class="sd">1.  To `bury` a dead datum means to save the elog data and a copy of any</span>
<span class="sd">    Metadata attributes to MongoDB.  These are stored in special &quot;cemetery&quot;</span>
<span class="sd">    collection that has no schema constraints.   Every dead datum the</span>
<span class="sd">    undertaker is told to &quot;bury&quot; will produce a document in one of two</span>
<span class="sd">    location:  (1) if it is a normal datum the body will be saved in &quot;cemetery&quot;</span>
<span class="sd">    (2) if is an &quot;abortion&quot; the body will be saved in &quot;abortions&quot;.</span>
<span class="sd">2.  To `mummify` a dead datum means to not save anything but return only</span>
<span class="sd">    a shell of the original with a minimal memory footprint.  For atomic</span>
<span class="sd">    data that means to set the sample array to zero length.  For ensembles</span>
<span class="sd">    it means to mummify all dead members but leave the mummies in the container.</span>
<span class="sd">    An ensemble marked dead passed through mummify will have all it&#39;s members</span>
<span class="sd">    mummified.</span>
<span class="sd">3.  To `cremate` a dead datum means to make it disappear with little to no</span>
<span class="sd">    trace.   When an atomic datum is cremated we return a default constructed</span>
<span class="sd">    version of the object.   We do that instead of a None to streamline</span>
<span class="sd">    use of the cremate feature in a parallel workflow.   Some but not all</span>
<span class="sd">    MsPASS processing functions will correctly handle None input so returning</span>
<span class="sd">    the ashes is preferable to just an empty symbol (None type).  Ensembles are</span>
<span class="sd">    simpler.  When an ensemble is cremated all dead members are vaporized</span>
<span class="sd">    with no trace and the member vector will contain only live members.</span>

<span class="sd">A datum that is defined as an &quot;abortion&quot; is handled a bit differently</span>
<span class="sd">by design.   We take a pro life stance in MsPaSS and view abortions as</span>
<span class="sd">always a bad thing that need to be minimized and monitored.  For that</span>
<span class="sd">reason they cannot be &quot;cremated&quot; - that makes no sense anyway since</span>
<span class="sd">in most cases the sample data in an aborted object are invalid anyway.</span>
<span class="sd">Data found to be &quot;aborted&quot; (regularized throught private method `is_abortion`)</span>
<span class="sd">are always treated differently an buried in a separate area with the</span>
<span class="sd">name &quot;abortions&quot;.  The document contents also differ slightly.   Note</span>
<span class="sd">there is no such thing, currently, as an aborted ensemble.   Only atomic</span>
<span class="sd">data can satisfy that concept.  It is easy to generate an ensemble of</span>
<span class="sd">all aborted data, most notable when reading with &#39;mode=&quot;pedantic&quot;&#39;,</span>
<span class="sd">but the undertaker treats such ensembles as a collection of atomic objects</span>
<span class="sd">and automatically buries all abortions it finds.</span>

<span class="sd">Documents that are the remnants of dead object saved in two collection.</span>
<span class="sd">by default normal killed data create records in the &quot;cemetery&quot; collection</span>
<span class="sd">while aborted data objects produce documents in the &quot;abortions&quot;</span>
<span class="sd">collection.  All contain an optional &quot;data_tag&quot; defined by the</span>
<span class="sd">Undertaker on construction.  Use a unique &quot;data_tag&quot; for any job</span>
<span class="sd">to make the source of the document unambiguous.  A common example is</span>
<span class="sd">that an Undertaker is defined in Database and the data_tag is passed</span>
<span class="sd">used by writers.</span>

<span class="sd">:author: Prof. Gary L. Pavlis, Dept. Earth and Atmos. Sci., Indiana University</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Undertaker"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Undertaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to handle dead data. Results are stored to two spcial</span>
<span class="sd">    collections defined by default as &quot;cemetery&quot;, for regular dead bodies,</span>
<span class="sd">    and &quot;abortions&quot; for those defined as abortions.</span>

<span class="sd">    :param dbin:   Should be an instance of  mspasspy.db.Database that is</span>
<span class="sd">      used to save the remains of any bodies.</span>

<span class="sd">    :type dbin:  the constructor for this class only tests for that the</span>
<span class="sd">      handle is an instance of pymongo&#39;s Database class.  The MsPASS</span>
<span class="sd">      version of Database extends the pymongo version.  Thsi particular</span>
<span class="sd">      class references only two methods of Database: (1) the private</span>
<span class="sd">      method `_save_elog` and (2) the private method `_save_history`.</span>
<span class="sd">      Technically an alternative extension of pymongo&#39;s Database</span>
<span class="sd">      class that implements those two methods would be plug compatible.</span>
<span class="sd">      User&#39;s who might want to pull MsPASS apart and use this class</span>
<span class="sd">      separately could do so with an alternative Database extension than</span>
<span class="sd">      MsPaSs.</span>

<span class="sd">    :param regular_data_collection:  collection where we bury regular</span>
<span class="sd">    dead bodies.  Default &quot;cemetery&quot;</span>
<span class="sd">    :type regular_data_collection:  string</span>

<span class="sd">    :param aborted_data_collection:  collection where aborted data documents</span>
<span class="sd">    are buried.   Default &quot;abortions&quot;</span>
<span class="sd">    :type aborted_data_collection:  string</span>

<span class="sd">    :param data_tag:   tag to attach to each document.  Normally would</span>
<span class="sd">    be the same as the data_tag used for a particular save operation</span>
<span class="sd">    for data not marked dead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dbin</span><span class="p">,</span>
        <span class="n">regular_data_collection</span><span class="o">=</span><span class="s2">&quot;cemetery&quot;</span><span class="p">,</span>
        <span class="n">aborted_data_collection</span><span class="o">=</span><span class="s2">&quot;abortions&quot;</span><span class="p">,</span>
        <span class="n">data_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor takes only one argument.  Expected to be a</span>
<span class="sd">        mspasspy.db.Database object (the mspass database handle)</span>
<span class="sd">        or it will throw an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># shared by all error handlers as initialization</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Undertaker constructor:  &quot;</span>
        <span class="c1"># pymongo.database.Database is the base class for</span>
        <span class="c1"># Database (here meaning mspasspy.db.database.Database) but this</span>
        <span class="c1"># seems necessary for some contexts.   If given a base class</span>
        <span class="c1"># instance some class methods here will fail that use mspass</span>
        <span class="c1"># extensions</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbin</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Database</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">dbin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">elog</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;arg0 must be a MsPASS Database class (mspasspy.db.Database)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Type of content passed to constructor=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dbin</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regular_data_collection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regular_data_collection</span> <span class="o">=</span> <span class="n">regular_data_collection</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aborted_data_collection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aborted_data_collection</span> <span class="o">=</span> <span class="n">aborted_data_collection</span>
        <span class="k">if</span> <span class="n">data_tag</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_tag</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_tag</span> <span class="o">=</span> <span class="n">data_tag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Illegal type=</span><span class="si">{}</span><span class="s2"> for data tag.  Must be str&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data_tag</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># allow None type to be carried through - data tag not set in this situation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_tag</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Undertaker.bury"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker.bury">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">bury</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mspass_object</span><span class="p">,</span>
        <span class="n">save_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mummify_atomic_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles dead data by saving a subset of content to database.</span>

<span class="sd">        MsPASS makes extensive use of the idea of &quot;killing&quot; data as a</span>
<span class="sd">        way to say it is bad and should not be considered further in</span>
<span class="sd">        any analysis.   There is a need to record what data was killed</span>
<span class="sd">        and it is preferable to do so without saving the entire</span>
<span class="sd">        data object.  (That is the norm in seismic reflection processing</span>
<span class="sd">        where data marked dead are normally carried through until</span>
<span class="sd">        removed through a process like a stack.)  This method</span>
<span class="sd">        standardizes the method of how to do that and what is saved</span>
<span class="sd">        as the shell of a dead datum.  That &quot;shell&quot; is always a minimum</span>
<span class="sd">        of two things:</span>
<span class="sd">            1.  All elog entries - essential to understand why datum was killed</span>
<span class="sd">            2.  The content of the Metadata container saved under a</span>
<span class="sd">                subdocument called &quot;tombstone&quot;.</span>
<span class="sd">        If save_history is set True and the datum has history records</span>
<span class="sd">        they will also be saved.</span>

<span class="sd">        It is important to realize this method acts like an overloaded</span>
<span class="sd">        c++ method in that it accepts multiple data types, but handles</span>
<span class="sd">        them differently.</span>
<span class="sd">        1.  Atomic data (TimeSeries or Seismogram) marked dead</span>
<span class="sd">            generate a document saved to the specified collection and</span>
<span class="sd">            an (optional) history document.   If the mummify_atomic_data</span>
<span class="sd">            parameter is set True (the default) the returned copy of the</span>
<span class="sd">            data will be processed with the &quot;mummify&quot; method of this class.</span>
<span class="sd">            (That means the sample data are discarded and the array is set</span>
<span class="sd">             to zero length).</span>
<span class="sd">        2.  Ensembles have to handle two different situations.   If the</span>
<span class="sd">            entire ensemble is marked dead, all members are treated as</span>
<span class="sd">            dead and then processed through this method by a recursive</span>
<span class="sd">            call on each member.   In that situation an empty ensemble</span>
<span class="sd">            is returned with only ensemble metadata not empty.  If the</span>
<span class="sd">            ensemble is marked live the code loops over members</span>
<span class="sd">            calling this method recusively only on dead data.   In</span>
<span class="sd">            that situation the ensemble returned is edited with</span>
<span class="sd">            all dead data removed.   (e.g. if we started with 20 members</span>
<span class="sd">            and two were marked dead, the return would have 18 members.)</span>

<span class="sd">        :param mspass_object:   datum to be processed</span>
<span class="sd">        :type mspass_object:  Must be a MsPASS seismic data object</span>
<span class="sd">          (TimeSeries, Seismogram, TimeSeriesEnsemble, or SeismogramEnsemble)</span>
<span class="sd">          or the method will throw a TypeError.</span>


<span class="sd">        :param save_history:  If True and a datum has the optional history</span>
<span class="sd">          data stored with it, the history data will be stored in a</span>
<span class="sd">          MongoDB collection hard wired into the _save_history method of</span>
<span class="sd">          Database.  Default is False</span>

<span class="sd">        :param mummify_atomic_data:  When True (default) atomic data</span>
<span class="sd">          marked dead will be passed through self.mummify to reduce</span>
<span class="sd">          memory use of the remains.   This parameter is ignored for ensembles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set as symbol to mesh with Database api.  It would make no sense</span>
        <span class="c1"># to ever set this False.  Done this way to make that clear</span>
        <span class="n">save_elog</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># warning:  because this method may be called on a datum</span>
        <span class="c1"># with problematic Metadata it could fail if a metadata</span>
        <span class="c1"># value cannot be saved in MongoDB.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_abortion</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">):</span>
                    <span class="n">mspass_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_abortion</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">save_elog</span><span class="p">:</span>
                        <span class="c1"># Note confusion that _save_elog actually does</span>
                        <span class="c1"># the burial in this case.  A bit of a maintenance</span>
                        <span class="c1"># issue so beware</span>
                        <span class="n">cemeteryid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_save_elog</span><span class="p">(</span>
                            <span class="n">mspass_object</span><span class="p">,</span>
                            <span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_data_collection</span><span class="p">,</span>
                            <span class="n">data_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tag</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">mspass_object</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_data_collection</span> <span class="o">+</span> <span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cemeteryid</span>
                    <span class="k">if</span> <span class="n">save_history</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_save_history</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">alg_name</span><span class="o">=</span><span class="s2">&quot;Undertaker.bury&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mummify_atomic_data</span><span class="p">:</span>
                        <span class="c1"># these are not defaults.  If we saved the elog and history</span>
                        <span class="c1"># to the database there is no reason to keep it so we clear</span>
                        <span class="c1"># both with this set of options</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mummify</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">post_elog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">post_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">mspass_object</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeriesEnsemble</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
                <span class="c1"># if ensemble is marked dead make sure all the membes</span>
                <span class="c1"># are marked dead - allows loop below to do its job also</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="c1"># Note the indent here so all ensembles pass through this</span>
            <span class="c1"># loop.  Buries all dead members and returns a copy of the</span>
            <span class="c1"># ensembles with the bodies removed</span>
            <span class="n">ensmd</span> <span class="o">=</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">_get_ensemble_md</span><span class="p">()</span>
            <span class="n">nlive</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                    <span class="n">nlive</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">):</span>
                <span class="n">newens</span> <span class="o">=</span> <span class="n">TimeSeriesEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">nlive</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
                <span class="n">newens</span> <span class="o">=</span> <span class="n">SeismogramEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">nlive</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MsPASSError</span><span class="p">(</span>
                    <span class="s2">&quot;Undertaker.bury&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Coding error - newens constructor section has invalid type</span><span class="se">\n</span><span class="s2">That cannot happen unless the original code was incorrectly changed&quot;</span><span class="p">,</span>
                    <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                    <span class="n">newens</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bury</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">save_history</span><span class="o">=</span><span class="n">save_history</span><span class="p">,</span> <span class="n">mummify_atomic_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nlive</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newens</span><span class="o">.</span><span class="n">set_live</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">newens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Undertaker.bury:  Datum received is not a MsPASS data object</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Type of arg0 received =</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="Undertaker.bury_the_dead"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker.bury_the_dead">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">bury_the_dead</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mspass_object</span><span class="p">,</span>
        <span class="n">save_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mummify_atomic_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Depricated method exactly equivalent to new, and shorter name of</span>
<span class="sd">        simply `bury`.   With context as a member of Undertaker the</span>
<span class="sd">        long name was redundnant.  Note the call sequence is exactly</span>
<span class="sd">        the same as bury.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Undertaker.bury_the_dead:  depricated method.  Use shorter, equivalent bury method instead&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING:  may disappear in future releases&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bury</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">save_history</span><span class="p">,</span> <span class="n">mummify_atomic_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Undertaker.cremate"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker.cremate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">cremate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mspass_object</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like bury but nothing is preserved of the dead.</span>

<span class="sd">        Fpr atomic data it returns a default constructed (empty)</span>
<span class="sd">        copy of the container matching the original type.</span>
<span class="sd">        That avoids downstream type collisions if this method is</span>
<span class="sd">        called in parallel workflow to release memory.</span>
<span class="sd">        This method is most appropriate for ensembles.  In that case, it</span>
<span class="sd">        returns a copy of the ensemble with all dead data removed.</span>
<span class="sd">        (i.e. they are ommited from the returned copy leaving no trace.)</span>
<span class="sd">        If an ensemble is marked dead the return is an empty ensemble</span>
<span class="sd">        containing only ensemble Metadata.</span>

<span class="sd">        :param mspass_object:  Seismic data object.   If not a MsPASS</span>
<span class="sd">          seismic data object a TypeError will be thrown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mspass_object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_abortion</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bury</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">)</span>
                <span class="c1"># cremation of atomic objects generate default constructed ashes</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">TimeSeries</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Seismogram</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeriesEnsemble</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
                <span class="n">nlive</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Note the indent here so all ensembles pass through this</span>
            <span class="c1"># loop.  Buries all abortions and returns a copy of the</span>
            <span class="c1"># ensembles with the all bodies (regular and abortions) removed</span>
            <span class="n">ensmd</span> <span class="o">=</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">_get_ensemble_md</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                <span class="n">nlive</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                        <span class="n">nlive</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">):</span>
                <span class="n">newens</span> <span class="o">=</span> <span class="n">TimeSeriesEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">nlive</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
                <span class="n">newens</span> <span class="o">=</span> <span class="n">SeismogramEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">nlive</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MsPASSError</span><span class="p">(</span>
                    <span class="s2">&quot;Undertaker.cremate:  &quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Coding error - newens constructor section has invalid type</span><span class="se">\n</span><span class="s2">That cannot happen unless the original code was incorrectly changed&quot;</span><span class="p">,</span>
                    <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                        <span class="n">newens</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Not elif to assure kill and abortion definition</span>
                        <span class="c1"># are cleanly separated</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_abortion</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">bury</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nlive</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">newens</span><span class="o">.</span><span class="n">set_live</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">newens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Undertaker.cremate:  Datum received is not a MsPASS data object</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Type of arg0 received =</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="Undertaker.bring_out_your_dead"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker.bring_out_your_dead">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">bring_out_your_dead</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">d</span><span class="p">,</span>
        <span class="n">bury</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mummify_atomic_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Seperate an ensemble into live and dead members.  Result is</span>
<span class="sd">        returned as a pair (tuple) of two ensembles.   First (0 component)</span>
<span class="sd">        is a copy of the input with the dead bodies removed.  The second</span>
<span class="sd">        (component 1) has the same ensemble Metadata as the input but only</span>
<span class="sd">        contains dead members - like the name implies stolen from a great line in</span>
<span class="sd">        the Monty Python movie &quot;Search for the Holy Grail&quot;.</span>

<span class="sd">        :param d:  must be either a TimeSeriesEnsemble or SeismogramEnsemble of</span>
<span class="sd">           data to be processed.</span>
<span class="sd">        :param bury:  if true the bury method will be called on the</span>
<span class="sd">           ensemble of dead data before returning.   Note a limitation of</span>
<span class="sd">           using this method is there is no way to save the optional</span>
<span class="sd">           history data via this method.  If you need to save history</span>
<span class="sd">           run this with bury=False and then run bury with save_history</span>
<span class="sd">           true on the dead ensemble.   There is also no way to specify</span>
<span class="sd">           an alternative to the default collection name of &quot;cemetery&quot;</span>
<span class="sd">        :return: python list with two elements. 0 is ensemble with live data</span>
<span class="sd">           and 1 is ensemble with dead data.</span>
<span class="sd">        :rtype:  python list with two components</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">)):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Undertaker.bring_out_your_dead:  &quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Illegal type passed for arg0</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Actual type of arg0=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Must be TimeSeriesEnsemble or SeismgoramEnsemble</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># make sure all members are dead if the ensemble is marked dead</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="c1"># This is a pybind11 wrapper not defined in C++ but useful here</span>
        <span class="n">ensmd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">_get_ensemble_md</span><span class="p">()</span>
        <span class="n">nlive</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                <span class="n">nlive</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ndead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">)</span> <span class="o">-</span> <span class="n">nlive</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">):</span>
            <span class="n">newens</span> <span class="o">=</span> <span class="n">TimeSeriesEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">nlive</span><span class="p">)</span>
            <span class="n">bodies</span> <span class="o">=</span> <span class="n">TimeSeriesEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">ndead</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
            <span class="n">newens</span> <span class="o">=</span> <span class="n">SeismogramEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">nlive</span><span class="p">)</span>
            <span class="n">bodies</span> <span class="o">=</span> <span class="n">SeismogramEnsemble</span><span class="p">(</span><span class="n">ensmd</span><span class="p">,</span> <span class="n">ndead</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MsPASSError</span><span class="p">(</span>
                <span class="s2">&quot;Undertaker.bring_out_your_dead&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Coding error - newens constructor section has invalid type</span><span class="se">\n</span><span class="s2">That cannot happen unless the original code was incorrectly changed&quot;</span><span class="p">,</span>
                <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                <span class="n">newens</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bodies</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="c1"># Note we don&#39;t support save_history through this</span>
                <span class="c1"># mechanism.</span>
                <span class="k">if</span> <span class="n">bury</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bury</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newens</span><span class="o">.</span><span class="n">member</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newens</span><span class="o">.</span><span class="n">set_live</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">newens</span><span class="p">,</span> <span class="n">bodies</span><span class="p">]</span></div>

<div class="viewcode-block" id="Undertaker.mummify"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker.mummify">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">mummify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mspass_object</span><span class="p">,</span> <span class="n">post_elog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">post_history</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce memory use associated with dead data.</span>

<span class="sd">        For atomic data objects if they are marked dead</span>
<span class="sd">        the data vector/matrix is set to zero length releasing</span>
<span class="sd">        the dynamically allocated memory.  For Ensembles if</span>
<span class="sd">        the entire ensemble is marked dead all members are</span>
<span class="sd">        killed and this method calls itself on each member.</span>
<span class="sd">        For normal ensembles with mixed live and dead data</span>
<span class="sd">        only the data marked dead are muffified.</span>

<span class="sd">        Handling of</span>

<span class="sd">        :param mspass_object:  datum to be processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">mspass_object</span><span class="p">,</span>
            <span class="p">(</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Undertaker.mumify:  arg0 must be a mspass seismic data object.  Actual type received = &quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># Note:  this method currently does nothing special for abortions</span>
        <span class="c1"># That should be ok because all ways we create abortions have</span>
        <span class="c1"># objects constructed far enough that the algorithm below shouldn&#39;t</span>
        <span class="c1"># fail.   Adding ways to abort could invaldate that assumption</span>
        <span class="k">if</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">post_elog</span><span class="p">:</span>
                <span class="n">elog_doc</span> <span class="o">=</span> <span class="n">elog2doc</span><span class="p">(</span><span class="n">mspass_object</span><span class="o">.</span><span class="n">elog</span><span class="p">)</span>
                <span class="n">mspass_object</span><span class="p">[</span><span class="s2">&quot;error_log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elog_doc</span>
                <span class="n">mspass_object</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)):</span>
                <span class="c1"># Note history only makes sense for atomic data so this</span>
                <span class="c1"># section needs to be here</span>
                <span class="k">if</span> <span class="n">post_history</span><span class="p">:</span>
                    <span class="n">hisdoc</span> <span class="o">=</span> <span class="n">history2doc</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">)</span>
                    <span class="n">mspass_object</span><span class="p">[</span><span class="s2">&quot;processing_history&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hisdoc</span>
                    <span class="n">mspass_object</span><span class="o">.</span><span class="n">clear_history</span><span class="p">()</span>
                <span class="n">mspass_object</span><span class="o">.</span><span class="n">set_npts</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeriesEnsemble</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">)):</span>
                <span class="c1"># Note this is executed if the entire ensemble is marked</span>
                <span class="c1"># dead.  We then force a kill of all members and mummify all</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mummify</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">post_elog</span><span class="p">,</span> <span class="n">post_history</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># only need to do anything if we land here if this is an ensemble</span>
            <span class="c1"># i.e. we will silently return an atomnic object marked live</span>
            <span class="c1"># for ensembles we mummify dead members</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mspass_object</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeriesEnsemble</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mspass_object</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mummify</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">post_elog</span><span class="p">,</span> <span class="n">post_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mspass_object</span></div>

<div class="viewcode-block" id="Undertaker.handle_abortion"><a class="viewcode-back" href="../../../python_api/mspasspy.util.html#mspasspy.util.Undertaker.Undertaker.handle_abortion">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_abortion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_or_datum</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standardized method to handle what we call abortions (see class overview).</span>

<span class="sd">        This method standardizes handling of abortions.  They are always</span>
<span class="sd">        saved as a document in a collection set by the constructor</span>
<span class="sd">        (self.aborted_data_collection) that defaults to &quot;abortions&quot;.</span>
<span class="sd">        The documents saved have up to 3 key-value pairs:</span>
<span class="sd">            &quot;tombstone&quot; - contents are a subdocument (dict) of the</span>
<span class="sd">              wf document that was aborted during construction.</span>
<span class="sd">            &quot;logdata&quot; - any error log records left by the reeader that failed.</span>
<span class="sd">            &quot;type&quot; -  string describing the expected type of data object</span>
<span class="sd">              that a reader was attempting to construct.   In rare</span>
<span class="sd">              situations it could be set to &quot;unknown&quot; if</span>
<span class="sd">              Undertaker._handle_abortion is called on a raw document</span>
<span class="sd">              and type is not set (see parameters below)</span>

<span class="sd">        :param doc_or_datum:  container defining the aborted fetus.</span>
<span class="sd">        :type doc_or_datum:  Must be one of `TimeSeries`, `Seismogram`, `Metadata`,</span>
<span class="sd">        or a python dict.   For the seismic data objects any content in</span>
<span class="sd">        the ErrorLogger will be saved.   For dict input an application</span>
<span class="sd">        should post a message to the dict with some appropriate (custom)</span>
<span class="sd">        key to preserve a cause for the abortion.</span>

<span class="sd">        :param type: string description of the type of data object</span>
<span class="sd">        to associate with dict input.  Default for this parameter is None</span>
<span class="sd">        and it is not referenced at all for normal input of TimeSeries</span>
<span class="sd">        and Seismogram objects.  It is ONLY referenced if arg0 is a</span>
<span class="sd">        dict. If type is None and the input is a dict the value assigned to</span>
<span class="sd">        the &quot;type&quot; key in the abortions document is &quot;unknown&quot;.   The</span>
<span class="sd">        escape for &quot;unknown&quot; makes the method bombproof but may make the</span>
<span class="sd">        saved documents ambiguous.</span>

<span class="sd">        :exception:  throws a TypeError if arg0 does not obey type</span>
<span class="sd">        list described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">insertion_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tag</span><span class="p">:</span>
            <span class="n">insertion_doc</span><span class="p">[</span><span class="s2">&quot;data_tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tag</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Metadata</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">,</span> <span class="n">Metadata</span><span class="p">):</span>
                <span class="n">remains</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remains</span> <span class="o">=</span> <span class="n">doc_or_datum</span>
            <span class="c1"># Note made a list to be consistent with ensemble version</span>
            <span class="n">insertion_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tombstone&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">remains</span><span class="p">]}</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">insertion_doc</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this should not be entered but is safer to include it</span>
                <span class="n">insertion_doc</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)):</span>
            <span class="n">insertion_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tombstone&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">doc_or_datum</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logdata</span> <span class="o">=</span> <span class="n">elog2doc</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">)</span>
                <span class="n">insertion_doc</span><span class="p">[</span><span class="s2">&quot;logdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logdata</span>
            <span class="n">insertion_doc</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Undertaker.handle_abortion:   Illegal type for arg0=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">doc_or_datum</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Must be a TimeSeries, Seismogram, or a dict&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">insertion_doc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">aborted_data_collection</span><span class="p">]</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">insertion_doc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">doc_or_datum</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_abortion</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method used to standardize test for whether a datum is</span>
<span class="sd">        wha we call an &quot;abortion&quot;.   The test is trivial in this case</span>
<span class="sd">        because of the use of the &quot;is_abortion&quot; Metadata attribute in</span>
<span class="sd">        our readers.   Could be more complex so this design assures</span>
<span class="sd">        separation of the concept from the implementation.</span>
<span class="sd">        :param d:  datum to be tested.</span>
<span class="sd">        :type d: TimeSeries or Seismogram.  We do test for this as the</span>
<span class="sd">        cost is small and a TypeError will be thrown if d is not either of</span>
<span class="sd">        these types.  Considered bypassing the test but better to</span>
<span class="sd">        make the package more robust.</span>

<span class="sd">        :return: boolean True if datum is an abortion, False othewise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_defined</span><span class="p">(</span><span class="s2">&quot;is_abortion&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;is_abortion&quot;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Warning:  dead datum has is_abortion attribute undefined - assumed False</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;MsPASS readers should always set this attribute&quot;</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">MsPASSError</span><span class="p">(</span>
                    <span class="s2">&quot;Undertaker._is_abortion&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span>
                <span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Undertaker._is_abortion:  received an input that is an invalid type - must be either a TimeSeries or Seismogram object&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, Ian Wang.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>