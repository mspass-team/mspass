

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>mspasspy.algorithms.window &mdash; MsPASS 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />  

  <style>
    .wy-nav-content { max-width: 1600px; }
  </style>

  
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> MsPASS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/run_mspass_with_docker.html">Run MsPASS with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_with_docker_compose.html">Deploy MsPASS with Docker Compose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/deploy_mspass_on_HPC.html">Deploy MsPASS on HPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started_overview.html">MsPASS Setup In-Depth Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/data_object_design_concepts.html">Data Object Design Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/time_standard_constraints.html">Time Standard Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/obspy_interface.html">Using ObsPy with MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/database_concepts.html">Database Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/CRUD_operations.html">CRUD Operations in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/importing_data.html">Importing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/handling_errors.html">Handling Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/data_editing.html">Data Editing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/header_math.html">Header (Metadata) Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/graphics.html">Graphics in MsPASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/processing_history_concepts.html">Processing History Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/parallel_processing.html">Parallel Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/normalization.html">Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual/adapting_algorithms.html">Adapting an Existing Algorithm to MsPASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cxx_api/index.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mspass_schema/mspass_schema.html">MsPASS Schema</a></li>
</ul>

            
          
    <a href= "../../../genindex.html">Index</a>
  
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MsPASS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mspasspy.algorithms.window</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mspasspy.algorithms.window</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">mspasspy.ccore.utility</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MsPASSError</span><span class="p">,</span>
    <span class="n">AtomicType</span><span class="p">,</span>
    <span class="n">ErrorSeverity</span><span class="p">,</span>
    <span class="n">ProcessingStatus</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mspasspy.ccore.seismic</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Seismogram</span><span class="p">,</span>
    <span class="n">TimeSeries</span><span class="p">,</span>
    <span class="n">TimeSeriesEnsemble</span><span class="p">,</span>
    <span class="n">SeismogramEnsemble</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mspasspy.ccore.algorithms.basic</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TimeWindow</span><span class="p">,</span>
    <span class="n">_TopMute</span><span class="p">,</span>
    <span class="n">_WindowData</span><span class="p">,</span>
    <span class="n">_WindowData3C</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mspasspy.ccore.algorithms.amplitudes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_scale</span><span class="p">,</span>
    <span class="n">_scale_ensemble</span><span class="p">,</span>
    <span class="n">_scale_ensemble_members</span><span class="p">,</span>
    <span class="n">ScalingMethod</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mspasspy.util.decorators</span> <span class="kn">import</span> <span class="n">mspass_func_wrapper</span>


<div class="viewcode-block" id="ensemble_error_post"><a class="viewcode-back" href="../../../python_api/mspasspy.algorithms.html#mspasspy.algorithms.window.ensemble_error_post">[docs]</a><span class="k">def</span> <span class="nf">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">severity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a small helper function useful for error handlers in except</span>
<span class="sd">    blocks for ensemble objects.  If a function is called on an ensemble</span>
<span class="sd">    object that throws an exception this function will post the message</span>
<span class="sd">    posted to all ensemble members.  It silently does nothing if the</span>
<span class="sd">    ensemble is empty.</span>
<span class="sd">    :param d: is the ensemble data to be handled.  It print and error message</span>
<span class="sd">      and returns doing nothing if d is not one of the known ensemble</span>
<span class="sd">      objects.</span>
<span class="sd">    :param alg: is the algorithm name posted to elog on each member</span>
<span class="sd">    :param message: is the string posted to all members</span>
<span class="sd">    :param severity: is the error severity level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">severity</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Coding error - ensemble_error_post was passed an unexpected data type of&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not treated as fatal but a bug fix is needed&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_post_amplitude</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">amp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal small helper function for repeated tests of method - posts the</span>
<span class="sd">    computed amplitudes to metadata with a different key for each method</span>
<span class="sd">    used to compute amplitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;rms&quot;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMS&quot;</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;rms_amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;perc_amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MAD&quot;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mad&quot;</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;mad_amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span>


<div class="viewcode-block" id="scale"><a class="viewcode-back" href="../../../python_api/mspasspy.algorithms.html#mspasspy.algorithms.window.scale">[docs]</a><span class="nd">@mspass_func_wrapper</span>
<span class="c1"># inplace_return was intentionally ommitted from thie arg list here because</span>
<span class="c1"># False should always be enforced.  If the default changed that would</span>
<span class="c1"># break this function.</span>
<span class="k">def</span> <span class="nf">scale</span><span class="p">(</span>
    <span class="n">d</span><span class="p">,</span>
    <span class="n">compute_from_window</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;peak&quot;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">scale_by_section</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">use_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">object_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alg_name</span><span class="o">=</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span>
    <span class="n">alg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">function_return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Top level function interface to data scaling methods.</span>

<span class="sd">    This function can be used to scale seismic data contained in any of</span>
<span class="sd">    the four seismic data objects defined in mspass:  TimeSeries, Seismogram,</span>
<span class="sd">    TimeSeriesEnsemble, and SeismogramEnsemble.   An extensive set of</span>
<span class="sd">    amplitude estimation metrics are available by selecting one of the</span>
<span class="sd">    allowed values for the method parameter.   Ensembles can be scaled</span>
<span class="sd">    at the individual seismogram level or as a whole (scale_by_section=True).</span>

<span class="sd">    Note all methods preserve the original amplitude by updating the</span>
<span class="sd">    Metadata parameter calib to include the scaling.  i.e. as always the</span>
<span class="sd">    amplitude of the data in physical units can be restored by multiplying</span>
<span class="sd">    the data samples by calib.</span>

<span class="sd">    :param d:  is input data object.  If not one of the four mspass seismic</span>
<span class="sd">      data types noted above the function will throw a RuntimeError exception.</span>
<span class="sd">    :param compute_from_window: boolean used to compute amplitude and scale</span>
<span class="sd">      based on a windowed section of the input waveform.   By default (this</span>
<span class="sd">      boolan False) the amplitude for scaling is computed from the full</span>
<span class="sd">      waveform.  When True the window argument must contain a valid TimeWindow</span>
<span class="sd">      that spans a time range smaller than the data range.  In that situation</span>
<span class="sd">      if the window is inconsistent with the data range the return will be</span>
<span class="sd">      marked dead and messages will be found posted in elog.  For ensembles</span>
<span class="sd">      all or only  portion of the group will be killed if this happens.</span>
<span class="sd">      Note this parameter is also ignored when scale_by_section is true.</span>
<span class="sd">    :param window:  mspass TimeWindow object defining the time range</span>
<span class="sd">      over which the amplitude for scaling is to be computed.  (see the</span>
<span class="sd">      compute_from_window parameter description)</span>
<span class="sd">    :param method: string defining the gain method to use.  Currently supported</span>
<span class="sd">      method values are:  peak, RMS (rms accepted), perc, and MAD</span>
<span class="sd">      (also accepts mad or Mad).  Peak uses the largest amplitude for</span>
<span class="sd">      scaling.  For 3C data that means vector amplitude while for scalar data</span>
<span class="sd">      it is the largest absolute value. rms is the standard rms measure,</span>
<span class="sd">      although for 3C data is is rms vector amplitudes so scaling is by the</span>
<span class="sd">      number of vectors not the total number of samples (3 times number of</span>
<span class="sd">      vectors).  perc uses a sorted percentage clip level metric as used in</span>
<span class="sd">      seismic unix.  mad is a variant where the value returned is the</span>
<span class="sd">      median absolute deviation (mad) that is actual the same as perc=1/2.</span>
<span class="sd">      Default is peak.  WARNING:  if an invalid value for method is passed the</span>
<span class="sd">      data will be returned unaltered with a complaint message issue for</span>
<span class="sd">      very datum (indivually or in ensembles) run that way.</span>
<span class="sd">    :param level:   For all but perc this defines the scale to which the data</span>
<span class="sd">      are scaled.  For perc it is used to set the percent clip level.</span>
<span class="sd">      If the value passed is illegal (0 or negative for most methods while</span>
<span class="sd">      perc must also be positive but less or equal 1) a complain message will</span>
<span class="sd">      be posted to elog and the level adjusted to 1.0.</span>
<span class="sd">    :param scale_by_section:  is a boolean that controls the scaling</span>
<span class="sd">      behavior on ensembles only (It is silently ignored for atomic</span>
<span class="sd">      TimeSeries and Seismogram data).  When true a single gain factor is</span>
<span class="sd">      applied to all members of an ensemble.  When false each member is</span>
<span class="sd">      gained individually as if this function were applied in a loop to</span>
<span class="sd">      each member.</span>
<span class="sd">    :param use_mean:  boolean used only for ensembles and when scale_by_section is</span>
<span class="sd">      True.   The algorithm used in that case has an option to use the mean</span>
<span class="sd">      log amplitude for scaling the section instead of the default median</span>
<span class="sd">      amplitude.</span>

<span class="sd">    :return: Data scaled to specified level.  Note the scaling always preserves</span>
<span class="sd">      absolute amplitude by adjusting the value of the calib attribute of the</span>
<span class="sd">      return so calib*data is the same value before and after the scaling.</span>
<span class="sd">    :rtype: same as input</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">d</span>
    <span class="c1"># First validate arguments</span>
    <span class="c1"># The logic here would be much cleaner if ensembles had an elog attribute</span>
    <span class="c1"># may happen as group discussions have proposed that change.  this should</span>
    <span class="c1"># change to be cleaner of elog is added to ensmeble objects</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;peak&quot;</span>
        <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;RMS&quot;</span>
        <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;rms&quot;</span>
        <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;perc&quot;</span>
        <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;MAD&quot;</span>
        <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;mad&quot;</span>
    <span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;method parameter passed = &quot;</span>
            <span class="o">+</span> <span class="n">method</span>
            <span class="o">+</span> <span class="s2">&quot; is not valid.  Should be peak, rms, perc, or mad</span><span class="se">\n</span><span class="s2">Continuing with no change to data&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
            <span class="n">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This could cause an abort if the input is not one of the four stock data types</span>
            <span class="c1"># but that is ok as that is an obvious usage error and should be a fatal error</span>
            <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span>
                <span class="n">alg_name</span><span class="p">,</span>
                <span class="s2">&quot;method parameter passed = &quot;</span>
                <span class="o">+</span> <span class="n">method</span>
                <span class="o">+</span> <span class="s2">&quot; is not valid.  &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Should be peak, rms, perc, or mad&quot;</span><span class="p">,</span>
                <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;perc scaling method given illegal value=</span><span class="si">{plevel}</span><span class="se">\n</span><span class="s2">Defaulted to 1.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">plevel</span><span class="o">=</span><span class="n">level</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
                <span class="n">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{meth}</span><span class="s2"> scaling method given illegal value=</span><span class="si">{slevel}</span><span class="se">\n</span><span class="s2">Defaulted to 1.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">meth</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">slevel</span><span class="o">=</span><span class="n">level</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
                <span class="n">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">compute_from_window</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">TimeWindow</span><span class="p">):</span>
            <span class="n">ampwin</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;optional window parameter set but value is not a TimeWindow object</span><span class="se">\n</span><span class="s2">Reverting to unwindowed estimate&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
                <span class="n">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">)</span>
            <span class="c1"># this is an invalid window because start&gt;end is used as a signal</span>
            <span class="c1"># in WindowData to use the entire waveform.  It switches automatically</span>
            <span class="c1"># without logging an error (currently).  Definitely a little weird</span>
            <span class="c1"># but this hides that detail for python users</span>
            <span class="n">ampwin</span> <span class="o">=</span> <span class="n">TimeWindow</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ampwin</span> <span class="o">=</span> <span class="n">TimeWindow</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="c1"># The pybind11 and C++ way of defining an enum class creates an</span>
    <span class="c1"># obnoxiously ugly syntax. We insulate the user from this oddity</span>
    <span class="c1"># by using a string arg to define this enum passed to _scale</span>
    <span class="n">method_to_use</span> <span class="o">=</span> <span class="n">ScalingMethod</span><span class="o">.</span><span class="n">Peak</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;rms&quot;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMS&quot;</span><span class="p">:</span>
        <span class="n">method_to_use</span> <span class="o">=</span> <span class="n">ScalingMethod</span><span class="o">.</span><span class="n">RMS</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span>
        <span class="n">method_to_use</span> <span class="o">=</span> <span class="n">ScalingMethod</span><span class="o">.</span><span class="n">perc</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MAD&quot;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mad&quot;</span><span class="p">:</span>
        <span class="n">method_to_use</span> <span class="o">=</span> <span class="n">ScalingMethod</span><span class="o">.</span><span class="n">MAD</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Note this logic depends on an oddity of the C++ api in the</span>
        <span class="c1"># functions called with the _scale binding name.   When the TimeWindow</span>
        <span class="c1"># is invalid the entire data range is silently used - not viewed as</span>
        <span class="c1"># an error.  Hence, the following works only when the logic above to</span>
        <span class="c1"># handle the definition of the window parameter is set.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">_scale</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">method_to_use</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">ampwin</span><span class="p">)</span>
            <span class="n">_post_amplitude</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">method_to_use</span><span class="p">,</span> <span class="n">amp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeriesEnsemble</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SeismogramEnsemble</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Silently return nothing if the ensemble is empy</span>
                <span class="k">return</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">scale_by_section</span><span class="p">:</span>
                <span class="n">amp</span> <span class="o">=</span> <span class="n">_scale_ensemble</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">method_to_use</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">use_mean</span><span class="p">)</span>
                <span class="c1"># We post the amplitude the ensembe&#39;s metadata in this case</span>
                <span class="n">_post_amplitude</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">method_to_use</span><span class="p">,</span> <span class="n">amp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ampvec</span> <span class="o">=</span> <span class="n">_scale_ensemble_members</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">method_to_use</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">ampwin</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
                        <span class="n">_post_amplitude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">method_to_use</span><span class="p">,</span> <span class="n">ampvec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MsPASSError</span><span class="p">(</span>
                <span class="s2">&quot;scale: input data is not a supported mspass seismic data type&quot;</span><span class="p">,</span> <span class="s2">&quot;Fatal&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">except</span> <span class="n">MsPASSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">alg_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="c1"># avoid further isinstance at the expense of a maintenance issue.</span>
        <span class="c1"># if we add any other supported data objects we could have a</span>
        <span class="c1"># problem here.  This assumes what lands here is an ensemble</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">member</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c1"># this is needed to handle an oddity recommended on this</span>
    <span class="c1"># web site:  http://effbot.org/zone/stupid-exceptions-keyboardinterrupt.htm</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Something threw an unexpected exception</span><span class="se">\n</span><span class="s2">That is a bug that needs to be fixed - contact authors&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ensemble_error_post</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowData"><a class="viewcode-back" href="../../../python_api/mspasspy.algorithms.html#mspasspy.algorithms.window.WindowData">[docs]</a><span class="nd">@mspass_func_wrapper</span>
<span class="k">def</span> <span class="nf">WindowData</span><span class="p">(</span>
    <span class="n">d</span><span class="p">,</span>
    <span class="n">win_start</span><span class="p">,</span>
    <span class="n">win_end</span><span class="p">,</span>
    <span class="n">t0shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">object_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alg_name</span><span class="o">=</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span>
    <span class="n">alg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cut data defined by a TimeWindow object.</span>

<span class="sd">    Cutting a smaller waveform segment from a larger waveform segment</span>
<span class="sd">    is a very common seismic data processing task.   The function is</span>
<span class="sd">    a python wrapper to adapt C++ code that accomplishes that task</span>
<span class="sd">    to the MsPASS framework.</span>

<span class="sd">    Note this function uses one model for being bombproof with a map</span>
<span class="sd">    operation.  Any exception that makes the result invalid will cause</span>
<span class="sd">    an error message to be posted to the elog attribute of the input</span>
<span class="sd">    datum AND the data will be marked dead (killed).</span>

<span class="sd">    :param d: is the input data.  d must be either a :class:`mspasspy.ccore.seismic.TimeSeries` or :class:`mspasspy.ccore.seismic.Seismogram`</span>
<span class="sd">      object or the function will log an error to d and return a None.</span>
<span class="sd">    :param twin_start: defines the start of timeWindow to be cut</span>
<span class="sd">    :type twin_start: :class:`float`</span>
<span class="sd">    :param twin_end: defines the end of timeWindow to be cut</span>
<span class="sd">    :type twin_end: :class:`float`</span>
<span class="sd">    :param t0shift: is an optional time shift to apply to the time window.</span>
<span class="sd">      This parameter is convenient to avoid conversions to relative time.</span>
<span class="sd">      A typical example would be to set t0shift to an arrival time and let</span>
<span class="sd">      the window define time relative to that arrival time.  Default is None</span>
<span class="sd">      which cause the function to assume twin is to be used directly.</span>
<span class="sd">    :param object_history: boolean to enable or disable saving object</span>
<span class="sd">      level history.  Default is False.  Note this functionality is</span>
<span class="sd">      implemented via the mspass_func_wrapper decorator.</span>
<span class="sd">    :param alg_name:   When history is enabled this is the algorithm name</span>
<span class="sd">      assigned to the stamp for applying this algorithm.</span>
<span class="sd">      Default (&quot;WindowData&quot;) should normally be just used.</span>
<span class="sd">      Note this functionality is implemented via the mspass_func_wrapper decorator.</span>
<span class="sd">    :param ald_id:  algorithm id to assign to history record (used only if</span>
<span class="sd">      object_history is set True.)</span>
<span class="sd">      Note this functionality is implemented via the mspass_func_wrapper decorator.</span>
<span class="sd">    :param dryrun:</span>
<span class="sd">      Note this functionality is implemented via the mspass_func_wrapper decorator.</span>
<span class="sd">    :param dryrun:</span>
<span class="sd">      Note this functionality is implemented via the mspass_func_wrapper decorator.</span>

<span class="sd">    :return: copy of d with sample range reduced to twin range.  Returns</span>
<span class="sd">      an empty version of the parent data type (default constructor) if</span>
<span class="sd">      the input is marked dead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="n">twcut</span> <span class="o">=</span> <span class="n">TimeWindow</span><span class="p">(</span><span class="n">win_start</span><span class="p">,</span> <span class="n">win_end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t0shift</span><span class="p">:</span>
        <span class="n">twcut</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t0shift</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># This handler duplicates an error test in the WindowData C code but</span>
        <span class="c1"># it will be more efficient to handle it here.</span>
        <span class="k">if</span> <span class="n">twcut</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">.</span><span class="n">t0</span> <span class="ow">or</span> <span class="n">twcut</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">endtime</span><span class="p">():</span>
            <span class="n">detailline</span> <span class="o">=</span> <span class="s2">&quot;Window range: </span><span class="si">{wst}</span><span class="s2">,</span><span class="si">{wet}</span><span class="s2">  Data range:  </span><span class="si">{dst}</span><span class="s2">,</span><span class="si">{det}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">wst</span><span class="o">=</span><span class="n">twcut</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">wet</span><span class="o">=</span><span class="n">twcut</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">endtime</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span>
                <span class="s2">&quot;WindowData&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Data range is smaller than window range</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">detailline</span><span class="p">,</span>
                <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">):</span>
            <span class="n">dcut</span> <span class="o">=</span> <span class="n">_WindowData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">twcut</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dcut</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">):</span>
            <span class="n">dcut</span> <span class="o">=</span> <span class="n">_WindowData3C</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">twcut</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dcut</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;WindowData:  Invalid input data type received=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="n">MsPASSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s2">&quot;WindowData&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="WindowData_with_duration"><a class="viewcode-back" href="../../../python_api/mspasspy.algorithms.html#mspasspy.algorithms.window.WindowData_with_duration">[docs]</a><span class="nd">@mspass_func_wrapper</span>
<span class="k">def</span> <span class="nf">WindowData_with_duration</span><span class="p">(</span>
    <span class="n">d</span><span class="p">,</span>
    <span class="n">duration</span><span class="p">,</span>
    <span class="n">t0shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">object_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alg_name</span><span class="o">=</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span>
    <span class="n">alg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">detailline</span> <span class="o">=</span> <span class="s2">&quot;Window duration: </span><span class="si">{dur}</span><span class="s2">  Data range:  </span><span class="si">{dst}</span><span class="s2">,</span><span class="si">{det}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">endtime</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span>
            <span class="s2">&quot;WindowData&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Duration is a negative number.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">detailline</span><span class="p">,</span>
            <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="n">win_start</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">win_end</span> <span class="o">=</span> <span class="n">win_start</span> <span class="o">+</span> <span class="n">duration</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="n">twcut</span> <span class="o">=</span> <span class="n">TimeWindow</span><span class="p">(</span><span class="n">win_start</span><span class="p">,</span> <span class="n">win_end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t0shift</span><span class="p">:</span>
        <span class="n">twcut</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t0shift</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># This handler duplicates an error test in the WindowData C code but</span>
        <span class="c1"># it will be more efficient to handle it here.</span>
        <span class="k">if</span> <span class="n">win_start</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">.</span><span class="n">t0</span> <span class="ow">or</span> <span class="n">win_end</span> <span class="o">&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">endtime</span><span class="p">():</span>
            <span class="n">detailline</span> <span class="o">=</span> <span class="s2">&quot;Window range: </span><span class="si">{wst}</span><span class="s2">,</span><span class="si">{wet}</span><span class="s2">  Data range:  </span><span class="si">{dst}</span><span class="s2">,</span><span class="si">{det}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">wst</span><span class="o">=</span><span class="n">win_start</span><span class="p">,</span> <span class="n">wet</span><span class="o">=</span><span class="n">win_end</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">endtime</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span>
                <span class="s2">&quot;WindowData&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Data range is smaller than window range</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">detailline</span><span class="p">,</span>
                <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">):</span>
            <span class="n">dcut</span> <span class="o">=</span> <span class="n">_WindowData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">twcut</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dcut</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">):</span>
            <span class="n">dcut</span> <span class="o">=</span> <span class="n">_WindowData3C</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">twcut</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dcut</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;WindowData:  Invalid input data type received=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="n">MsPASSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s2">&quot;WindowData&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="TopMute"><a class="viewcode-back" href="../../../python_api/mspasspy.algorithms.html#mspasspy.algorithms.window.TopMute">[docs]</a><span class="k">class</span> <span class="nc">TopMute</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A top mute is a form of taper applied to the &quot;front&quot; of a signal.</span>
<span class="sd">    Front in standard jargon means that with the time axis running from</span>
<span class="sd">    left to right (normal unless your native language is Arabic) the time</span>
<span class="sd">    period on the left side of a plot.   Data tagged at times less than what we</span>
<span class="sd">    call the zero time here are always zeroed.  The mute defines a ramp function</span>
<span class="sd">    running from the zero time to the &quot;one&quot; time.  In the ramp zone the</span>
<span class="sd">    ramp function multiplies the sample data so it is a form of &quot;taper&quot; as</span>
<span class="sd">    used in Fourier analysis.  This class should normally only be used on data with the time</span>
<span class="sd">    reference type set Relative.  It can be applied to UTC time standard data but</span>
<span class="sd">    with such data one of these objects would often need to be created for</span>
<span class="sd">    each atomic data object, which would be horribly inefficient.  In most</span>
<span class="sd">    cases conversion to relative time is an essential step before using</span>
<span class="sd">    this algorithm.</span>


<span class="sd">    This implementation uses an &quot;apply&quot; method for processing data.</span>
<span class="sd">    That means for a parallel construct instead of the symbol for a function</span>
<span class="sd">    you use the apply method as a function call.  (e.g. if tm is an is an</span>
<span class="sd">    instance of this class and &quot;d&quot; is a TimeSeries or Seismogram object to be</span>
<span class="sd">    muted the function call that applies the mute would be ts.apply(d))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a TopMute object for application to MsPASS data objects.</span>

<span class="sd">        The constructor is a pythonic front end to the C++ version of this</span>
<span class="sd">        class (it the same name in C++ but the binding code maps the C++</span>
<span class="sd">        name to _TopMute).  The args are the same but this wrapper allows</span>
<span class="sd">        keywords and removes positional requirements as usual in python.</span>

<span class="sd">        :param t0:  time of end of zeroing period of top Mute</span>
<span class="sd">        :param t1:  time of end of taper zone when the multiplier goes to 1</span>
<span class="sd">        :param type: form of ramp (currently must be either &quot;linear&quot; or &quot;cosine&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This call will throw a MsPASSError exception if the parameters</span>
        <span class="c1"># are mangled but we let that happen in this context assuming a</span>
        <span class="c1"># constructor like this is created outside any procesisng loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">_TopMute</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span>

<div class="viewcode-block" id="TopMute.apply"><a class="viewcode-back" href="../../../python_api/mspasspy.algorithms.html#mspasspy.algorithms.window.TopMute.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">object_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use thie method to apply the defined top mute to one of the MsPASS</span>
<span class="sd">        atomic data objects. The method does a sanity check on the input</span>
<span class="sd">        data range.  If the starttime of the data is greater than t0 for</span>
<span class="sd">        the mute the datum is killed and an error posted to elog.  The</span>
<span class="sd">        reason is in that situation the data would be completely zeroed</span>
<span class="sd">        anyway and it is better to define it dead and leave an error message</span>
<span class="sd">        than to completely null data.</span>
<span class="sd">        :param d:  input atomic MsPASS data object (TimeSeries or Seismogram)</span>
<span class="sd">        :object_history:  It set true the function will add define this</span>
<span class="sd">          step as an map operation to preserve object level history.</span>
<span class="sd">          (default is False)</span>
<span class="sd">        :param instance:   string defining the &quot;instance&quot; of this algorithm.</span>
<span class="sd">          This parameter is needed only if object_history is set True.  It</span>
<span class="sd">          is used to define which instance of this algrithm is being applied.</span>
<span class="sd">          (In the C++ api this is what is called the algorithm id).  I can</span>
<span class="sd">          come from the global history manager or be set manually.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MsPASSError</span><span class="p">(</span>
                <span class="s2">&quot;TopMute.apply:  usage error.  Input data must be a TimeSeries or Seismogram object&quot;</span><span class="p">,</span>
                <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">dead</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">t0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span>
                <span class="s2">&quot;TopMute.apply&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Data start time is later than time of mute zero zone</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Datum killed as this would produce a null signal&quot;</span><span class="p">,</span>
                <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">object_history</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instance</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="p">(</span>
                        <span class="s2">&quot;TopMute.apply&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Undefined instance argument - cannot save history data&quot;</span><span class="p">,</span>
                        <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">d</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">elog</span><span class="p">(</span>
                        <span class="s2">&quot;TopMute.apply&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Error log is empty.  Cannot be extended without a top level entry&quot;</span><span class="p">,</span>
                        <span class="n">ErrorSeverity</span><span class="o">.</span><span class="n">Complaint</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Seismogram</span><span class="p">):</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">new_map</span><span class="p">(</span>
                            <span class="s2">&quot;TopMute&quot;</span><span class="p">,</span>
                            <span class="n">instance</span><span class="p">,</span>
                            <span class="n">AtomicType</span><span class="o">.</span><span class="n">SEISMOGRAM</span><span class="p">,</span>
                            <span class="n">ProcessingStatus</span><span class="o">.</span><span class="n">VOLATILE</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">new_map</span><span class="p">(</span>
                            <span class="s2">&quot;TopMute&quot;</span><span class="p">,</span>
                            <span class="n">instance</span><span class="p">,</span>
                            <span class="n">AtomicType</span><span class="o">.</span><span class="n">TIMESERIES</span><span class="p">,</span>
                            <span class="n">ProcessingStatus</span><span class="o">.</span><span class="n">VOLATILE</span><span class="p">,</span>
                        <span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2021, Ian Wang.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>